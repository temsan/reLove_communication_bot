version: '3.8'

services:
  # PostgreSQL - существующий контейнер relove_postgres
  # ⚠️ ВАЖНО: Контейнер запущен отдельно, данные НЕ затираются!
  # Подключен к сети relove_network для связи с другими сервисами
  # Используется как external_link для совместимости

  # Redis - для FSM storage и кэша
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - relove_network

  # Qdrant - для поиска похожих пользователей (команда /similar)
  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - relove_network

  # reLove Communication Bot
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      BOT_TOKEN: ${BOT_TOKEN}
      # Подключение к существующему контейнеру relove_postgres через сеть
      DB_URL: postgresql+asyncpg://user:pass@relove_postgres:5432/dbname
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_API_BASE: ${LLM_API_BASE}
      MODEL_NAME: ${MODEL_NAME}
      TG_API_ID: ${TG_API_ID}
      TG_API_HASH: ${TG_API_HASH}
      TG_SESSION: ${TG_SESSION}
      OUR_CHANNEL_ID: ${OUR_CHANNEL_ID}
      DISCUSSION_CHANNEL_ID: ${DISCUSSION_CHANNEL_ID}
      ADMIN_IDS: ${ADMIN_IDS}
      LOGLEVEL: ${LOGLEVEL:-INFO}
      REDIS_URL: redis://redis:6379/0
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - relove_network
    volumes:
      - ./logs:/app/logs
      - ./relove_bot:/app/relove_bot
    ports:
      - "${BOT_PORT:-8080}:8080"
    # Явно указываем, что ждем relove_postgres (external контейнер)
    external_links:
      - relove_postgres

volumes:
  redis_data:
  qdrant_data:

networks:
  relove_network:
    driver: bridge
