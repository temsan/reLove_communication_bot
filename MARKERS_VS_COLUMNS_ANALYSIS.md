# üìä –ê–Ω–∞–ª–∏–∑: markers vs –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏

## üîç –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ï—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
```python
history_summary: Text          # –í—ã–∂–∏–º–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—â–µ–Ω–∏—è
profile_summary: Text          # –í—ã–∂–∏–º–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–ø–æ—Å—Ç—ã, —Ñ–æ—Ç–æ)
psychological_summary: Text    # –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–∞—Ä–∏
```

### –ù–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JSONB:
```python
markers: JSON                  # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ª—é–±—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫:
# markers['summary']           # ‚ùå –î—É–±–ª–∏—Ä—É–µ—Ç profile_summary?
# markers['relove_context']    # ‚ùå –î—É–±–ª–∏—Ä—É–µ—Ç psychological_summary?
# markers['last_message']      # ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `markers['summary']` vs `profile_summary`
- `markers['relove_context']` vs `psychological_summary`
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫–æ–µ –ø–æ–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- JSONB –ø–æ–ª—è —Å–ª–æ–∂–Ω–µ–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –ø–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
- –ù–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

### 3. –°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSONB —Ç—Ä–µ–±—É–µ—Ç –∫–æ–¥–∞
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ª–µ–≥—á–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

### 4. –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `markers` –º–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –∑–∞—Ç–µ—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```python
# –í–º–µ—Å—Ç–æ markers['summary']
user.profile_summary = "..."

# –í–º–µ—Å—Ç–æ markers['relove_context']
user.psychological_summary = "..."

# –í–º–µ—Å—Ç–æ markers['last_message']
user.markers = {'last_message': '...'}  # –¢–æ–ª—å–∫–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ –õ–µ–≥–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ markers (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```python
# –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏:
# - profile_summary
# - psychological_summary
# - history_summary

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ:
user.markers = {
    'profile_summary': '...',
    'psychological_summary': '...',
    'history_summary': '...'
}
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚ùå –ù–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –∑–∞–ø—Ä–æ—Å—ã

## üéØ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–º–ø–æ—Ä—Ç–∞

```python
# –ë—ã–ª–æ:
user.markers = user.markers or {}
user.markers['summary'] = summary
user.markers['relove_context'] = context

# –°—Ç–∞–ª–æ:
user.profile_summary = summary
user.psychological_summary = context
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å ProfileService

```python
# relove_bot/services/profile_service.py

async def analyze_profile(self, user_id: int, tg_user):
    # –ë—ã–ª–æ:
    user.markers = user.markers or {}
    user.markers['summary'] = summary
    
    # –°—Ç–∞–ª–æ:
    user.profile_summary = summary
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å handlers

```python
# relove_bot/handlers/common.py

# –ë—ã–ª–æ:
user.markers = user.markers or {}
user.markers['summary'] = summary
user.markers['relove_context'] = profile_summary

# –°—Ç–∞–ª–æ:
user.profile_summary = summary
user.psychological_summary = profile_summary
```

### –®–∞–≥ 4: –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ markers –≤ –∫–æ–ª–æ–Ω–∫–∏
UPDATE users 
SET 
    profile_summary = markers->>'summary',
    psychological_summary = markers->>'relove_context'
WHERE 
    markers IS NOT NULL 
    AND (markers->>'summary' IS NOT NULL OR markers->>'relove_context' IS NOT NULL);

-- –û—á–∏—Å—Ç–∏—Ç—å markers –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
UPDATE users
SET markers = markers - 'summary' - 'relove_context'
WHERE markers IS NOT NULL;
```

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏

```python
# –ë—ã–ª–æ:
has_summary = user.markers and user.markers.get('summary')

# –°—Ç–∞–ª–æ:
has_summary = user.profile_summary is not None
```

## üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ markers

### –î–ª—è —á–µ–≥–æ –æ—Å—Ç–∞–≤–∏—Ç—å markers:

```python
# ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
markers['last_message'] = "..."
markers['last_activity'] = datetime.now()

# ‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
markers['engagement_score'] = 0.85
markers['response_time_avg'] = 120

# ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏
markers['tags'] = ['active', 'interested_in_hero_journey']

# ‚úÖ A/B —Ç–µ—Å—Ç—ã
markers['ab_test_group'] = 'variant_a'

# ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–ª–∞–≥–∏
markers['has_seen_welcome'] = True
markers['preferred_language'] = 'ru'
```

### –î–ª—è —á–µ–≥–æ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å markers:

```python
# ‚ùå –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ profile_summary

# ‚ùå –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ psychological_summary

# ‚ùå –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ history_summary

# ‚ùå –ú–µ—Ç–∞—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ metaphysical_profile (—É–∂–µ –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞)
```

## üîß –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```python
class User(Base):
    # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    id: BigInteger
    username: String
    first_name: String
    last_name: String
    
    # –ü—Ä–æ—Ñ–∏–ª—å –∏ –∞–Ω–∞–ª–∏–∑ (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
    profile_summary: Text              # –í—ã–∂–∏–º–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    psychological_summary: Text        # –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    history_summary: Text              # –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è
    metaphysical_profile: JSON         # –ú–µ—Ç–∞—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSONB)
    markers: JSON = {
        'last_message': str,
        'last_activity': datetime,
        'engagement_score': float,
        'tags': List[str],
        'ab_test_group': str,
        'custom_flags': Dict[str, Any]
    }
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ | JSONB markers |
|----------|-------------------|---------------|
| –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ | ‚ö° –ë—ã—Å—Ç—Ä–æ | üêå –ú–µ–¥–ª–µ–Ω–Ω–æ |
| –ò–Ω–¥–µ–∫—Å—ã | ‚úÖ –î–∞ | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ |
| –¢–∏–ø–∏–∑–∞—Ü–∏—è | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| –ì–∏–±–∫–æ—Å—Ç—å | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π | ‚úÖ –ì–∏–±–∫–æ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚úÖ –í—ã—Å–æ–∫–∞—è | ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ |

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è:**
- –û—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
- –î–∞–Ω–Ω—ã—Ö, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–µ–Ω –ø–æ–∏—Å–∫
- –î–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ —á–∏—Ç–∞—é—Ç—Å—è
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å markers –¥–ª—è:**
- –í—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ–≥–æ–≤
- –ö–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
- –î–∞–Ω–Ω—ã—Ö, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è

## ‚úÖ –ò—Ç–æ–≥–æ

1. **–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫**
2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–º–ø–æ—Ä—Ç–∞ –∏ ProfileService**
3. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ**
4. **–û—Å—Ç–∞–≤–∏—Ç—å markers —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö/—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

–≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –∫–æ–¥:
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–µ–µ
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
