# –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –¢–µ–∫—É—â–∏–µ –ø–æ–ª—è

### 1. **profile** (Text)
**–¶–µ–ª—å:** –ü—Å–∏—Ö–æ–ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –ø–æ—Å—Ç–æ–≤/–±–∏–æ/–∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏

**–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:**
- ‚úÖ `scripts/profiles/fill_profiles_from_channels.py` - —Å–æ–∑–¥–∞—ë—Ç —á–µ—Ä–µ–∑ LLM –∏–∑ –ø–æ—Å—Ç–æ–≤+–±–∏–æ+–∫–∞–Ω–∞–ª–æ–≤
- ‚ùå `relove_bot/services/profile_service.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `psychological_summary`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- ‚ùå –ù–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ –±–æ—Ç–∞
- ‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç—ã LLM
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

---

### 2. **hero_stage** (JourneyStageEnum)
**–¶–µ–ª—å:** –≠—Ç–∞–ø –ø—É—Ç–∏ –≥–µ—Ä–æ—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

**–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:**
- ‚úÖ `scripts/profiles/fill_profiles_from_channels.py` - –≤—ã–∑—ã–≤–∞–µ—Ç `determine_journey_stage()` (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
- ‚ö†Ô∏è `relove_bot/services/journey_service.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `last_journey_stage`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- ‚ö†Ô∏è `journey_service.py` - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ç–∞–ø, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –±–æ—Ç–∞
- ‚ùå –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±—â–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ –µ—Å—Ç—å, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è

---

### 3. **metaphysics** (JSON)
**–¶–µ–ª—å:** –ú–µ—Ç–∞—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–ª–∞–Ω–µ—Ç–∞, –∫–∞—Ä–º–∞, —Å–≤–µ—Ç/—Ç—å–º–∞)

**–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:**
- ‚úÖ `scripts/profiles/fill_profiles_from_channels.py` - –≤—ã–∑—ã–≤–∞–µ—Ç `create_metaphysical_profile()` (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
- ‚ùå –ù–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- ‚ùå –ù–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚ùå –ù–µ—Ç –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª–µ –µ—Å—Ç—å, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

---

### 4. **history_summary** (Text)
**–¶–µ–ª—å:** –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

**–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:**
- ‚ùå –ù–∏–≥–¥–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- ‚ùå –ù–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ–æ–±—â–µ

---

## –ü—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ
1. **–ü–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** - profile, hero_stage, metaphysics —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ –±–æ—Ç –∏—Ö –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç
2. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π** - journey_service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `last_journey_stage` –≤–º–µ—Å—Ç–æ `hero_stage`
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ—É–Ω–∫—Ü–∏–π** - `determine_journey_stage()` –∏ `create_metaphysical_profile()` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

### üü° –°—Ä–µ–¥–Ω–∏–µ
4. **history_summary –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è** - –Ω–µ—Ç –ª–æ–≥–∏–∫–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
5. **profile_service —É—Å—Ç–∞—Ä–µ–ª** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ `psychological_summary`

---

## –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π - —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç—å

### ‚úÖ –ó–ê –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—é:

1. **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ—Ö–æ–∂–∏–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏/–∑–∞–ø—Ä–æ—Å–∞–º–∏
   - –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤
   - –ü–æ–¥–±–æ—Ä –ø–∞—Ä –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫

2. **–ë—ã—Å—Ç—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM**
   - –í–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–∫–µ–Ω—ã –¥–æ—Ä–æ–≥–∏–µ)
   - –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞—Å—Ç–µ–π –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –∑–∞–ø—Ä–æ—Å—É
   - RAG (Retrieval-Augmented Generation)

3. **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
   - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**
   - –ü–æ–¥–±–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è
   - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
   - Matching –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π

### ‚ùå –ü–†–û–¢–ò–í –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

1. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
   - –ù—É–∂–Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î (Pinecone, Weaviate, pgvector)
   - –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã

2. **–ü—Ä–æ—Ñ–∏–ª–∏ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è**
   - –ù–µ –Ω—É–∂–µ–Ω real-time –ø–æ–∏—Å–∫
   - –ú–æ–∂–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ü—Ä–æ—Å—Ç—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã

3. **–ú–∞–ª–∞—è –±–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ï—Å–ª–∏ <10k –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏–∑–±—ã—Ç–æ—á–Ω–∞
   - –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º/–º–∞—Ä–∫–µ—Ä–∞–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π

```python
# 1. –û–±–Ω–æ–≤–∏—Ç—å journey_service.py
user.last_journey_stage ‚Üí user.hero_stage

# 2. –û–±–Ω–æ–≤–∏—Ç—å profile_service.py
user.psychological_summary ‚Üí user.profile

# 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ telegram_service.py
async def determine_journey_stage(profile: str) -> JourneyStageEnum
async def create_metaphysical_profile(profile: str) -> dict
```

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–ø—Ç—ã

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–º–ø—Ç—ã –±–æ—Ç–∞:
system_prompt = f"""
–¢—ã –ù–∞—Ç–∞—à–∞ –í–æ–ª–∫–æ—à.

–ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{user.profile}

–≠–¢–ê–ü –ü–£–¢–ò: {user.hero_stage.value if user.hero_stage else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω'}

–ú–ï–¢–ê–§–ò–ó–ò–ö–ê: {user.metaphysics if user.metaphysics else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.
"""
```

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)

**–ö–æ–≥–¥–∞ –≤–Ω–µ–¥—Ä—è—Ç—å:**
- –ë–∞–∑–∞ >1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù—É–∂–µ–Ω —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–ö–∞–∫ –≤–Ω–µ–¥—Ä—è—Ç—å:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pgvector (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ PostgreSQL)
# –ù–µ –Ω—É–∂–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î

from pgvector.sqlalchemy import Vector

class User(Base):
    profile_embedding: Mapped[Optional[List[float]]] = mapped_column(
        Vector(1536),  # OpenAI ada-002
        nullable=True
    )

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
async def update_profile_embedding(user_id: int):
    user = await get_user(user_id)
    embedding = await openai.embeddings.create(
        model="text-embedding-ada-002",
        input=user.profile
    )
    user.profile_embedding = embedding.data[0].embedding
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- OpenAI embeddings: $0.0001 / 1K —Ç–æ–∫–µ–Ω–æ–≤
- 1000 –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ 500 —Ç–æ–∫–µ–Ω–æ–≤ = $0.05
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü = $0.60/–≥–æ–¥

---

## –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –°–µ–π—á–∞—Å (–±–µ–∑ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏):
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–ø—Ç—ã
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞

### –ü–æ—Ç–æ–º (—Å –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π):
- –ö–æ–≥–¥–∞ –±–∞–∑–∞ >1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pgvector (–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î)
- –°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–∞ (~$1/–≥–æ–¥)

**–í—ã–≤–æ–¥:** –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–∞, –Ω–æ –Ω–µ —Å—Ä–æ—á–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π.
