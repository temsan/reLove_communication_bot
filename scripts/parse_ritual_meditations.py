#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∏—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ–¥–∏—Ç–∞—Ü–∏—è—Ö –∏–∑ JSON —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram —á–∞—Ç–∞.
–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –î–∞—Ç–∞ - –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞ - –§–ò–û - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ - –ë—Ä–∏—Ñ
–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É –∏ —Å–æ–∑–¥–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–π LLM-–±—Ä–∏—Ñ.
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ CSV —Ñ–æ—Ä–º–∞—Ç.
"""
import json
import csv
import re
import sys
import asyncio
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Optional, Tuple

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫—É –¥–ª—è Windows
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ PYTHONPATH
sys.path.insert(0, str(Path(__file__).parent.parent))

OLEG_USER_ID = "user43518416"

def parse_text(text) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π)."""
    if isinstance(text, str):
        return text
    elif isinstance(text, list):
        result = []
        for item in text:
            if isinstance(item, str):
                result.append(item)
            elif isinstance(item, dict) and 'text' in item:
                result.append(item['text'])
        return ''.join(result)
    return ""

def extract_ritual_name(text: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
    text_lower = text.lower()
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è –ö–∏–Ω–∫–∞–∫—É-–¥–∑–∏
    if '–∫–∏–Ω–∫–∞–∫—É' in text_lower:
        return "–ö–∏–Ω–∫–∞–∫—É-–¥–∑–∏ (–•—Ä–∞–º –ó–æ–ª–æ—Ç–æ–≥–æ –ø–∞–≤–∏–ª—å–æ–Ω–∞)"
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω: "–¢–µ–º–∞ —Ä–∏—Ç—É–∞–ª–∞:" + –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ
    match = re.search(r'–¢–µ–º–∞\s+—Ä–∏—Ç—É–∞–ª–∞:\s*\n+\s*([^\n]+)', text, re.IGNORECASE | re.MULTILINE)
    if match:
        name = match.group(1).strip()
        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        name = re.sub(r'[^\w\s\-‚Äî(),]+', '', name).strip()
        if 5 < len(name) < 200:
            return name
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω: "–ó–¥–µ—Å—å –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ –æ—Ç —É—á–∏—Ç–µ–ª—è:" + –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ
    match = re.search(r'–ó–¥–µ—Å—å –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ –æ—Ç —É—á–∏—Ç–µ–ª—è:\s*\n+\s*([^\n]+)', text, re.IGNORECASE | re.MULTILINE)
    if match:
        name = match.group(1).strip()
        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        name = re.sub(r'[^\w\s\-‚Äî(),]+', '', name).strip()
        if 5 < len(name) < 200:
            return name
    
    # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞ –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏)
    lines = text.split('\n')
    for i, line in enumerate(lines[:5]):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫
        line = line.strip()
        if not line:
            continue
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        if any(skip in line.lower() for skip in ['–≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è', '—Ä–∏—Ç—É–∞–ª', '–º–µ–¥–∏—Ç–∞—Ü', '–¥–æ–±—Ä–æ', '–ø—Ä–∏–≥–ª–∞—à', '—Å—Å—ã–ª–∫–∞']):
            continue
        # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω–∞—è
        if line and line[0].isupper() and 5 < len(line) < 100:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –æ –≤—Å—Ç—Ä–µ—á–µ
            if '–≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è' not in line.lower() and '15.00' not in line.lower():
                return line
    
    return None

def extract_ritual_date(text: str, message_date: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—É —Ä–∏—Ç—É–∞–ª–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è."""
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∞—Ç—ã
    patterns = [
        r'(?:—Ä–∏—Ç—É–∞–ª–µ|—Ä–∏—Ç—É–∞–ª)\s+(?:–∑–∞–≤—Ç—Ä–∞|—Å–µ–≥–æ–¥–Ω—è|)(?:,\s*)?(\d{1,2}\s+(?:–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è|—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è))',
        r'(\d{1,2}\s+(?:–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è|—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è))',
    ]
    
    text_lower = text.lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "—Å–µ–≥–æ–¥–Ω—è" –∏–ª–∏ "–∑–∞–≤—Ç—Ä–∞"
    is_today = '—Ä–∏—Ç—É–∞–ª–µ —Å–µ–≥–æ–¥–Ω—è' in text_lower or '—Ä–∏—Ç—É–∞–ª —Å–µ–≥–æ–¥–Ω—è' in text_lower
    is_tomorrow = '—Ä–∏—Ç—É–∞–ª–µ –∑–∞–≤—Ç—Ä–∞' in text_lower or '—Ä–∏—Ç—É–∞–ª –∑–∞–≤—Ç—Ä–∞' in text_lower
    
    for pattern in patterns:
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            date_str = match.group(1).strip()
            # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
            try:
                # –ü–æ–ª—É—á–∞–µ–º –≥–æ–¥ –∏–∑ –¥–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è
                msg_date = datetime.fromisoformat(message_date.replace('Z', '+00:00'))
                year = msg_date.year
                
                # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É (–¥–µ–Ω—å + –º–µ—Å—è—Ü)
                month_names = {
                    '—è–Ω–≤–∞—Ä—è': 1, '—Ñ–µ–≤—Ä–∞–ª—è': 2, '–º–∞—Ä—Ç–∞': 3, '–∞–ø—Ä–µ–ª—è': 4,
                    '–º–∞—è': 5, '–∏—é–Ω—è': 6, '–∏—é–ª—è': 7, '–∞–≤–≥—É—Å—Ç–∞': 8,
                    '—Å–µ–Ω—Ç—è–±—Ä—è': 9, '–æ–∫—Ç—è–±—Ä—è': 10, '–Ω–æ—è–±—Ä—è': 11, '–¥–µ–∫–∞–±—Ä—è': 12
                }
                
                parts = date_str.split()
                day = int(parts[0])
                month_name = parts[1].lower()
                month = month_names.get(month_name)
                
                if month:
                    ritual_date = datetime(year, month, day)
                    
                    # –ï—Å–ª–∏ "–∑–∞–≤—Ç—Ä–∞", –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å
                    if is_tomorrow:
                        ritual_date = ritual_date.replace(day=day)
                    
                    return ritual_date.strftime('%d.%m.%Y')
            except:
                pass
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è–≤–Ω—É—é –¥–∞—Ç—É, –Ω–æ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "—Å–µ–≥–æ–¥–Ω—è" - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è
    if is_today:
        try:
            msg_date = datetime.fromisoformat(message_date.replace('Z', '+00:00'))
            return msg_date.strftime('%d.%m.%Y')
        except:
            pass
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è–≤–Ω—É—é –¥–∞—Ç—É, –Ω–æ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–∑–∞–≤—Ç—Ä–∞" - –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å –∫ –¥–∞—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if is_tomorrow:
        try:
            msg_date = datetime.fromisoformat(message_date.replace('Z', '+00:00'))
            ritual_date = msg_date.replace(day=msg_date.day + 1)
            return ritual_date.strftime('%Y-%m-%d')
        except:
            pass
    
    return None

def is_ritual_announcement(text: str, from_id: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–Ω–æ–Ω—Å–æ–º —Ä–∏—Ç—É–∞–ª–∞."""
    if from_id != OLEG_USER_ID:
        return False
    
    text_lower = text.lower()
    keywords = [
        '—Ä–∏—Ç—É–∞–ª', '—Ä–∏—Ç—É–∞–ª–µ', '–º–µ–¥–∏—Ç–∞—Ü', '–≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è', '—Ç–µ–º–∞ —Ä–∏—Ç—É–∞–ª–∞',
        '–∫–∏–Ω–∫–∞–∫—É', '–Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ –æ—Ç —É—á–∏—Ç–µ–ª—è'
    ]
    
    return any(keyword in text_lower for keyword in keywords)

def is_sharing_message(text: str, from_id: str, ritual_date: Optional[str] = None) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞."""
    if from_id == OLEG_USER_ID:
        # –°–æ–æ–±—â–µ–Ω–∏—è –û–ª–µ–≥–∞ —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é –∑–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è - –Ω–µ —Å—á–∏—Ç–∞–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º
        if '–±–ª–∞–≥–æ–¥–∞—Ä—é –≤—Å–µ—Ö –∑–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è' in text.lower() or '–ø–æ–ø—Ä–æ—à—É —Ä–∞–∑–¥–µ–ª–∏—Ç—å' in text.lower():
            return False
        return False
    
    # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if len(text.strip()) < 20:
        return False
    
    # –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
    keywords = [
        '–±–ª–∞–≥–æ–¥–∞—Ä—é', '–±–ª–∞–≥–æ–¥–∞—Ä', '–º–µ–¥–∏—Ç–∞—Ü', '—Ä–∏—Ç—É–∞–ª', '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª',
        '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞', '—É–≤–∏–¥–µ–ª', '—É–≤–∏–¥–µ–ª–∞', '–æ—â—É—â', '—Å–æ—Å—Ç–æ—è–Ω–∏–µ',
        '–æ–ø—ã—Ç', '—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ', '–ø–æ–≥—Ä—É–∂', '—Ö—Ä–∞–º', '–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤'
    ]
    
    text_lower = text.lower()
    return any(keyword in text_lower for keyword in keywords) or len(text) > 100

def parse_ritual_data(json_path: Path) -> Dict[Tuple[str, str, str], List[str]]:
    """
    –ü–∞—Ä—Å–∏—Ç JSON —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ä–∏—Ç—É–∞–ª–∞—Ö –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è—Ö.
    –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É.
    
    Returns:
        Dict —Å –∫–ª—é—á–æ–º (–î–∞—Ç–∞, –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞, –§–ò–û) –∏ —Å–ø–∏—Å–∫–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
    """
    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    messages = data.get('messages', [])
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É: (–î–∞—Ç–∞, –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞, –§–ò–û) -> [—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è]
    grouped_sharings = {}
    
    # –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª
    current_ritual = {
        'name': None,
        'date': None,
        'announcement_date': None
    }
    
    for msg in messages:
        msg_type = msg.get('type', '')
        from_id = msg.get('from_id', '')
        text = parse_text(msg.get('text', ''))
        date = msg.get('date', '')
        
        if not text:
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–æ—Å—Ç–æ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Ç—É–∞–ª)
        if from_id == OLEG_USER_ID:
            text_lower = text.lower()
            if ('—Å–ø–∞—Å–∏–±–æ' in text_lower and '—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è' in text_lower) or '–±–ª–∞–≥–æ–¥–∞—Ä—é –≤—Å–µ—Ö' in text_lower:
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Ç—É–∞–ª
                current_ritual = {
                    'name': None,
                    'date': None,
                    'announcement_date': None
                }
                continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–Ω–æ–Ω—Å–æ–º —Ä–∏—Ç—É–∞–ª–∞
        if is_ritual_announcement(text, from_id):
            ritual_name = extract_ritual_name(text)
            ritual_date = extract_ritual_date(text, date)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∏—Ç—É–∞–ª–µ
            if ritual_name:
                current_ritual['name'] = ritual_name
                current_ritual['announcement_date'] = date
            if ritual_date:
                current_ritual['date'] = ritual_date
                current_ritual['announcement_date'] = date
                # –ï—Å–ª–∏ –∏–º—è —Ä–∏—Ç—É–∞–ª–∞ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –¥–∞—Ç–∞, –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—â–∏–π —Ä–∏—Ç—É–∞–ª
                if not current_ritual['name']:
                    # –ò—â–µ–º –∏–º—è –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –û–ª–µ–≥–∞ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–∑–∞–¥)
                    for prev_msg in messages[max(0, messages.index(msg) - 10):messages.index(msg)]:
                        if prev_msg.get('from_id') == OLEG_USER_ID:
                            prev_text = parse_text(prev_msg.get('text', ''))
                            prev_name = extract_ritual_name(prev_text)
                            if prev_name:
                                current_ritual['name'] = prev_name
                                break
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
        if current_ritual['date'] and is_sharing_message(text, from_id):
            # –ë–µ—Ä–µ–º –¥–∞—Ç—É —Ä–∏—Ç—É–∞–ª–∞, –µ—Å–ª–∏ –æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –∏–Ω–∞—á–µ –¥–∞—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è
            ritual_date = current_ritual['date']
            ritual_name = current_ritual['name'] or "–†–∏—Ç—É–∞–ª"
            from_name = msg.get('from', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            
            # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
            sharing_text = text.replace('\n', ' ').strip()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É
            key = (ritual_date, ritual_name, from_name)
            if key not in grouped_sharings:
                grouped_sharings[key] = []
            grouped_sharings[key].append(sharing_text)
    
    return grouped_sharings

# –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ LLM
_llm_service_available = None
_llm_service_error_shown = False

def init_llm_service():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç LLM —Å–µ—Ä–≤–∏—Å –æ–¥–∏–Ω —Ä–∞–∑."""
    global _llm_service_available, _llm_service_error_shown
    
    if _llm_service_available is None:
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            from dotenv import load_dotenv
            load_dotenv()
            
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º LLM —Å–µ—Ä–≤–∏—Å
            from relove_bot.services.llm_service import llm_service
            _llm_service_available = llm_service
            print("‚úì LLM —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            _llm_service_available = False
            if not _llm_service_error_shown:
                print(f"‚ö†Ô∏è LLM —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
                print("   –ë—Ä–∏—Ñ—ã –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")
                _llm_service_error_shown = True
    
    return _llm_service_available

def detect_hero_journey_stage(sharings: List[str]) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–¥–∏—é –ø—É—Ç–∏ –≥–µ—Ä–æ—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞."""
    if not sharings:
        return ""
    
    combined_text = "\n\n---\n\n".join(sharings).lower()
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—É—Ç–∏ –≥–µ—Ä–æ—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
    hero_journey_patterns = {
        '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': ['–∏–∑–º–µ–Ω–∏–ª', '—Å—Ç–∞–ª', '–ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è', '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü', '–Ω–æ–≤—ã–π', '—Å—Ç–∞–ª–∞ –¥—Ä—É–≥–æ–π', '—Å—Ç–∞–ª –¥—Ä—É–≥–∏–º'],
        '–ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞': ['–≤–æ—à–µ–ª', '–≤—Å—Ç—É–ø–∏–ª', '–ø–µ—Ä–µ—à–µ–ª', '–ø–µ—Ä–µ—Å–µ–∫', '–Ω–∞—á–∞–ª', '–æ–∫–∞–∑–∞–ª–∞—Å—å', '–æ–∫–∞–∑–∞–ª—Å—è'],
        '–∏—Å–ø—ã—Ç–∞–Ω–∏—è': ['–∏—Å–ø—ã—Ç–∞–Ω', '–±–æ–∏', '–±–æ—Ä—å–±', '–ø—Ä–µ–æ–¥–æ–ª', '—Ç—Ä—É–¥–Ω–æ—Å—Ç', '–±–æ—è—Ö'],
        '–Ω–∞–≥—Ä–∞–¥–∞': ['–Ω–∞—à–µ–ª', '–æ–±—Ä–µ–ª', '–ø–æ–ª—É—á–∏–ª', '–æ—Ç–∫—Ä—ã–ª', '–æ—Å–æ–∑–Ω–∞–ª', '–≤—Å–ø–æ–º–Ω–∏–ª'],
        '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ': ['–≤–µ—Ä–Ω—É–ª—Å—è', '–≤–µ—Ä–Ω—É–ª–∞—Å—å', '–≤–µ—Ä–Ω—É–ª', '–ø—Ä–∏–Ω–µ—Å', '–≤–µ—Ä–Ω—É–≤—à–∏—Å—å'],
        '–∑–æ–≤': ['–∑–æ–≤', '–ø—Ä–∏–∑—ã–≤', '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª', '–ø–æ—Ç—è–Ω—É–ª–æ', '–ø–æ–∑–≤–∞–ª', '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞'],
        '–æ–±—ã—á–Ω—ã–π –º–∏—Ä': ['–æ–±—ã—á–Ω', '–ø—Ä–∏–≤—ã—á–Ω', '—Ä—É—Ç–∏–Ω']
    }
    
    # –ù–∞—Ö–æ–¥–∏–º —ç—Ç–∞–ø—ã –ø—É—Ç–∏ –≥–µ—Ä–æ—è (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
    for stage, words in hero_journey_patterns.items():
        if any(word in combined_text for word in words):
            stage_names = {
                '–æ–±—ã—á–Ω—ã–π –º–∏—Ä': '–û–±—ã—á–Ω—ã–π –º–∏—Ä',
                '–∑–æ–≤': '–ó–æ–≤ –∫ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—é',
                '–ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞': '–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞',
                '–∏—Å–ø—ã—Ç–∞–Ω–∏—è': '–ò—Å–ø—ã—Ç–∞–Ω–∏—è',
                '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': '–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è',
                '–Ω–∞–≥—Ä–∞–¥–∞': '–ù–∞–≥—Ä–∞–¥–∞',
                '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ': '–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ'
            }
            return stage_names.get(stage, stage)
    
    return ""

def create_extended_brief(sharings: List[str]) -> str:
    """–°–æ–∑–¥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –±—Ä–∏—Ñ –±–µ–∑ LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ relove."""
    if not sharings:
        return ""
    
    combined_text = "\n\n---\n\n".join(sharings).lower()
    original_text = "\n\n---\n\n".join(sharings)
    
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ relove
    keywords = {
        '–æ—â—É—â–µ–Ω–∏—è': ['–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª', '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞', '–æ—â—É—â', '—á—É–≤—Å—Ç–≤', '–≤–∏–±—Ä–∞—Ü', '–º—É—Ä–∞—à–∫', '–ø—Ä–æ–±–∏–ª', '–ø—Ä–æ—à–ª'],
        '–≤–∏–∑—É–∞–ª—å–Ω–æ–µ': ['—É–≤–∏–¥–µ–ª', '—É–≤–∏–¥–µ–ª–∞', '–≤–∏–¥–µ–ª', '–≤–∏–¥–µ–ª–∞', '–æ–±—Ä–∞–∑', '–∫–∞—Ä—Ç–∏–Ω', '—Ñ–æ—Ç–æ', '–ø–æ–∫–∞–∑–∞–ª'],
        '–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ': ['—Ö—Ä–∞–º', '—ç—Ç–∞–∂', '–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤', '—Ç–µ—Ä—Ä–∏—Ç–æ—Ä', '–∫–æ–º–Ω–∞—Ç', '–¥–≤–æ—Ä', '–≤–µ—Ä–∞–Ω–¥'],
        '—ç–Ω–µ—Ä–≥–∏—è': ['—ç–Ω–µ—Ä–≥', '–≤–∏–±—Ä–∞—Ü', '–ø–æ—Ç–æ–∫', '–∑–∞—Ä—è–¥', '—Ü–µ–Ω—Ç—Ä', '–≤–æ–ª–Ω', '—Ä–∞—Å—à–∏—Ä–µ–Ω'],
        '—Å–æ—Å—Ç–æ—è–Ω–∏–µ': ['—Å–ø–æ–∫–æ–π—Å—Ç–≤', '—Ä–∞—Å—Å–ª–∞–±', '–Ω–∞–ø—Ä—è–∂', '—Ç—Ä–µ–≤–æ–≥', '–ø—Ä–∏—è—Ç–Ω', '–ø–æ–∫–æ–π', '—É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω'],
        '–¥–≤–∏–∂–µ–Ω–∏–µ': ['—Ç–∞–Ω—Ü', '–¥–≤–∏–≥–∞–ª', '—Ç–µ–ª–æ', '–∫–∏–º–æ–Ω–æ', '–ø—Ä–∞–∫—Ç–∏–∫', '–±–æ–∏', '—Å–∞–º—É—Ä–∞–π', '–≤–æ–∏–Ω'],
        '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': ['–∏–∑–º–µ–Ω–∏–ª', '—Å—Ç–∞–ª', '–ø–æ–ª—É—á–∏–ª', '–ø—Ä–æ–∏–∑–æ—à–ª–æ', '–¥—Ä—É–≥', '–Ω–æ–≤—ã–π', '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü'],
        '–º—É–∑—ã–∫–∞': ['–º—É–∑—ã–∫', '–º–µ–ª–æ–¥–∏', '–∑–≤—É–∫', '—Ä–∏—Ç–º', '–∫–æ–º–ø–æ–∑–∏—Ü', '–ø–ª–µ–π–ª–∏—Å—Ç', '–±—É–±–µ–Ω'],
        '–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å': ['–±–ª–∞–≥–æ–¥–∞—Ä', '—Å–ø–∞—Å–∏–±–æ', '—Å–ø–∞—Å–∏–±', '–±–ª–∞–≥–æ–¥–∞—Ä—é'],
        '–ø—Ä–æ—à–ª—ã–µ –∂–∏–∑–Ω–∏': ['–ø—Ä–æ—à–ª', '–∏–Ω–∫–∞—Ä–Ω–∞—Ü', '–≤–æ–ø–ª–æ—â–µ–Ω', '–±—ã–ª', '–±—ã–ª–∞', '–∏–º–ø–µ—Ä–∞—Ç–æ—Ä', '—Å–∞–º—É—Ä–∞–π'],
        '–¥—É—Ö–∏ –∏ —ç–Ω–µ—Ä–≥–∏–∏': ['–¥—É—Ö', '–¥—É—Ö–∏', '—Å—É—â–Ω–æ—Å—Ç', '–ø—Ä–∏—Å—É—Ç—Å—Ç–≤', '–æ—â—É—â–∞–ª'],
        '–∏—Å—Ü–µ–ª–µ–Ω–∏–µ': ['–∏—Å—Ü–µ–ª', '–∏—Å—Ü–µ–ª—è—é—â', '–∑–∞–∂–∏–≤–ª–µ–Ω', '–ø—Ä–∏–Ω—è–ª–∏', '–ø—Ä–∏–Ω—è–ª'],
        '–≤—Å—Ç—Ä–µ—á–∞': ['–≤—Å—Ç—Ä–µ—Ç–∏–ª', '–≤—Å—Ç—Ä–µ—Ç–∏–ª–∞', '–≤—Å—Ç—Ä–µ—á', '–¥—É—à–∞', '–≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å'],
        '—Å–º–µ—Ä—Ç—å –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': ['—Å–º–µ—Ä—Ç', '—É–º–µ—Ä', '–ø—Ä–æ—à–µ–ª', '–ø—Ä–∏–Ω—è–ª', '–æ—Ç–ø—É—Å—Ç–∏–ª']
    }
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—É—Ç–∏ –≥–µ—Ä–æ—è
    hero_journey_patterns = {
        '–æ–±—ã—á–Ω—ã–π –º–∏—Ä': ['–æ–±—ã—á–Ω', '–ø—Ä–∏–≤—ã—á–Ω', '—Ä—É—Ç–∏–Ω'],
        '–∑–æ–≤': ['–∑–æ–≤', '–ø—Ä–∏–∑—ã–≤', '–ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª', '–ø–æ—Ç—è–Ω—É–ª–æ', '–ø–æ–∑–≤–∞–ª'],
        '–ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞': ['–≤–æ—à–µ–ª', '–≤—Å—Ç—É–ø–∏–ª', '–ø–µ—Ä–µ—à–µ–ª', '–ø–µ—Ä–µ—Å–µ–∫', '–Ω–∞—á–∞–ª'],
        '–∏—Å–ø—ã—Ç–∞–Ω–∏—è': ['–∏—Å–ø—ã—Ç–∞–Ω', '–±–æ–∏', '–±–æ—Ä—å–±', '–ø—Ä–µ–æ–¥–æ–ª', '—Ç—Ä—É–¥–Ω–æ—Å—Ç'],
        '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': ['–∏–∑–º–µ–Ω–∏–ª', '—Å—Ç–∞–ª', '–ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è', '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü', '–Ω–æ–≤—ã–π'],
        '–Ω–∞–≥—Ä–∞–¥–∞': ['–Ω–∞—à–µ–ª', '–æ–±—Ä–µ–ª', '–ø–æ–ª—É—á–∏–ª', '–æ—Ç–∫—Ä—ã–ª', '–æ—Å–æ–∑–Ω–∞–ª'],
        '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ': ['–≤–µ—Ä–Ω—É–ª—Å—è', '–≤–µ—Ä–Ω—É–ª–∞—Å—å', '–≤–µ—Ä–Ω—É–ª', '–ø—Ä–∏–Ω–µ—Å', '–≤–µ—Ä–Ω—É–≤—à–∏—Å—å']
    }
    
    # –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã
    themes = []
    for theme, words in keywords.items():
        if any(word in combined_text for word in words):
            themes.append(theme)
    
    # –ù–∞—Ö–æ–¥–∏–º —ç—Ç–∞–ø—ã –ø—É—Ç–∏ –≥–µ—Ä–æ—è
    journey_stages = []
    for stage, words in hero_journey_patterns.items():
        if any(word in combined_text for word in words):
            journey_stages.append(stage)
    
    # –°—Ç—Ä–æ–∏–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±—Ä–∏—Ñ –±–µ–∑ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑
    brief_parts = []
    
    # –í–∞—Ä–∏–∞–Ω—Ç—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
    theme_intros = [
        "–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –æ–ø—ã—Ç–∞:",
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã:",
        "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:",
        "–ü—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–º—ã:",
    ]
    
    journey_intros = [
        "–≠—Ç–∞–ø –ø—É—Ç–∏ –≥–µ—Ä–æ—è:",
        "–ü–æ–∑–∏—Ü–∏—è –Ω–∞ –ø—É—Ç–∏:",
        "–§–∞–∑–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:",
        "–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:",
    ]
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è (–ø–æ —Ö–µ—à—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
    text_hash = hash(original_text) % len(theme_intros)
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –æ–ø—ã—Ç –∏ —Ç–µ–º—ã
    if themes:
        main_themes = themes[:4]
        theme_text = ', '.join(main_themes)
        
        # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–º —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
        if '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è' in main_themes and '–ø—Ä–æ—à–ª—ã–µ –∂–∏–∑–Ω–∏' in main_themes:
            brief_parts.append(f"–û–ø—ã—Ç –≤–∫–ª—é—á–∞–µ—Ç {theme_text} —Å –≥–ª—É–±–æ–∫–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç —Å –ø—Ä–æ—à–ª—ã–º–∏ –∏–Ω–∫–∞—Ä–Ω–∞—Ü–∏—è–º–∏.")
        elif '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è' in main_themes:
            brief_parts.append(f"–ü—Ä–æ—è–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —á–µ—Ä–µ–∑ {', '.join([t for t in main_themes if t != '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è'][:2])}.")
        else:
            brief_parts.append(f"{theme_intros[text_hash]} {theme_text}.")
    
    # –ü—É—Ç—å –≥–µ—Ä–æ—è - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —ç—Ç–∞–ø—ã, –∏ —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
    if journey_stages:
        stage_names = {
            '–æ–±—ã—á–Ω—ã–π –º–∏—Ä': '–û–±—ã—á–Ω—ã–π –º–∏—Ä',
            '–∑–æ–≤': '–ó–æ–≤ –∫ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—é',
            '–ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞': '–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞',
            '–∏—Å–ø—ã—Ç–∞–Ω–∏—è': '–ò—Å–ø—ã—Ç–∞–Ω–∏—è',
            '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è': '–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è',
            '–Ω–∞–≥—Ä–∞–¥–∞': '–ù–∞–≥—Ä–∞–¥–∞',
            '–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ': '–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ'
        }
        
        main_stage = journey_stages[0]
        stage_name = stage_names.get(main_stage, main_stage)
        
        if main_stage == '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è':
            brief_parts.append("–ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.")
        elif main_stage == '–ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞':
            brief_parts.append("–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –≤ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.")
        elif main_stage == '–∏—Å–ø—ã—Ç–∞–Ω–∏—è':
            brief_parts.append("–≠—Ç–∞–ø –∏—Å–ø—ã—Ç–∞–Ω–∏–π –Ω–∞ –ø—É—Ç–∏ –≥–µ—Ä–æ—è.")
        else:
            brief_parts.append(f"{journey_intros[text_hash % len(journey_intros)]} {stage_name}.")
    
    # –ü—Ä–æ—à–ª—ã–µ –∂–∏–∑–Ω–∏ / –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–æ
    if '–ø—Ä–æ—à–ª—ã–µ –∂–∏–∑–Ω–∏' in themes:
        past_life_variants = [
            "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Å–≤—è–∑—å —Å –ø—Ä–æ—à–ª—ã–º–∏ –∏–Ω–∫–∞—Ä–Ω–∞—Ü–∏—è–º–∏.",
            "–ü—Ä–æ—è–≤–∏–ª–∏—Å—å —ç–ª–µ–º–µ–Ω—Ç—ã –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏.",
            "–í—Å–∫—Ä—ã–ª–∏—Å—å —Å–ª–æ–∏ –ø—Ä–æ—à–ª—ã—Ö –≤–æ–ø–ª–æ—â–µ–Ω–∏–π.",
            "–û—â—É—â–∞–µ—Ç—Å—è —Å–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∂–∏–∑–Ω—è–º–∏."
        ]
        brief_parts.append(past_life_variants[text_hash % len(past_life_variants)])
    
    # –ì–ª—É–±–∏–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–ª—É–±–æ–∫–∏–π –æ–ø—ã—Ç
    deep_themes = ['—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è', '–∏—Å—Ü–µ–ª–µ–Ω–∏–µ', '–ø—Ä–æ—à–ª—ã–µ –∂–∏–∑–Ω–∏', '–≤—Å—Ç—Ä–µ—á–∞', '—Å–º–µ—Ä—Ç—å –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è']
    has_deep = any(t in themes for t in deep_themes)
    
    if has_deep and len(brief_parts) < 3:
        deep_variants = [
            "–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–±–æ—Ç–∞ —Å –≥–ª—É–±–∏–Ω–Ω—ã–º–∏ —Å–ª–æ—è–º–∏ —Å–æ–∑–Ω–∞–Ω–∏—è.",
            "–ó–∞–ø—É—â–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –≥–ª—É–±–æ–∫–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞–±–æ—Ç—ã.",
            "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –≥–ª—É–±–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã."
        ]
        brief_parts.append(deep_variants[text_hash % len(deep_variants)])
    
    # –ï—Å–ª–∏ –º–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞
    if len(brief_parts) < 2:
        first_sentences = '. '.join(original_text.split('.')[:2])
        if len(first_sentences) > 30:
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ–ª–∞–µ–º –∫—Ä–∞—Ç–∫–æ
            first_sentences = ' '.join(first_sentences.split()[:12])
            brief_parts.append(f"{first_sentences}...")
    
    return ' '.join(brief_parts)

async def create_brief(sharings: List[str]) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –±—Ä–∏—Ñ –∏–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ relove –∏ –ø—É—Ç–∏ –≥–µ—Ä–æ—è.
    –ï—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±—Ä–∏—Ñ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
    """
    if not sharings:
        return ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å LLM —Å–µ—Ä–≤–∏—Å–∞
    llm_service = init_llm_service()
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
    combined_text = "\n\n---\n\n".join(sharings)
    
    # –ï—Å–ª–∏ LLM –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    if llm_service:
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ–≥–æ –±—Ä–∏—Ñ–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º relove –∏ –ø—É—Ç–∏ –≥–µ—Ä–æ—è
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Ä–∏—Ç—É–∞–ª—å–Ω–æ–π –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–π —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –±—Ä–∏—Ñ (5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–†–ê–ó–î–ï–õ–ï–ù–ò–Ø –£–ß–ê–°–¢–ù–ò–ö–ê:
{combined_text}

–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô –° –¢–û–ß–ö–ò –ó–†–ï–ù–ò–Ø RELOVE –ò –ü–£–¢–ò –ì–ï–†–û–Ø:

1. **–û–°–ù–û–í–ù–û–ô –û–ü–´–¢** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
   - –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –≤–æ –≤—Ä–µ–º—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏
   - –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –æ—â—É—â–µ–Ω–∏—è, –æ–±—Ä–∞–∑—ã, —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –ß—Ç–æ –±—ã–ª–æ —Å–∞–º—ã–º –∑–Ω–∞—á–∏–º—ã–º

2. **–ê–ù–ê–õ–ò–ó –ü–£–¢–ò –ì–ï–†–û–Ø** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
   - –ù–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –ø—É—Ç–∏ –≥–µ—Ä–æ—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫ (–û–±—ã—á–Ω—ã–π –º–∏—Ä, –ó–æ–≤, –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞, –ò—Å–ø—ã—Ç–∞–Ω–∏—è, –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è)
   - –ß—Ç–æ —ç—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ –µ–≥–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

3. **–ü–†–û–ó–†–ï–ù–ò–Ø –ò –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
   - –ö–∞–∫–∏–µ –≤–∞–∂–Ω—ã–µ –ø—Ä–æ–∑—Ä–µ–Ω–∏—è –∏–ª–∏ –∏–Ω—Å–∞–π—Ç—ã –ø–æ—è–≤–∏–ª–∏—Å—å
   - –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
   - –ß—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫ –æ—Ç–∫—Ä—ã–ª –≤ —Å–µ–±–µ

4. **–ú–ï–¢–ê–§–ò–ó–ò–ß–ï–°–ö–ò–ô –ö–û–ù–¢–ï–ö–°–¢ RELOVE** (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ):
   - –°–≤—è–∑—å —Å –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏, –ø—Ä–æ—à–ª—ã–º–∏ –∂–∏–∑–Ω—è–º–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –ì–ª—É–±–∏–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–ª–∏ —ç–Ω–µ—Ä–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—è–≤–∏–ª–∏—Å—å

–ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º, –∏–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º."""
        
        try:
            brief = await llm_service.analyze_text(
                prompt=prompt,
                system_prompt="""–¢—ã –º—É–¥—Ä—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é relove –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –ø—É—Ç–∏ –≥–µ—Ä–æ—è. 
–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –æ–ø—ã—Ç –ª—é–¥–µ–π —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≥–ª—É–±–∏–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –º–µ—Ç–∞—Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
–°–æ–∑–¥–∞–≤–∞–π —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏ –≥–ª—É–±–æ–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.""",
                max_tokens=500
            )
            if brief and brief.strip():
                return brief.strip()
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LLM-–±—Ä–∏—Ñ–∞: {e}")
    
    # –ï—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±—Ä–∏—Ñ
    return create_extended_brief(sharings)

async def main_async():
    """–û—Å–Ω–æ–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    # –ü—É—Ç—å –∫ JSON —Ñ–∞–π–ª—É
    json_path = Path('data/ritual_meditation/result.json')
    
    if not json_path.exists():
        print(f'‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {json_path}')
        return
    
    print(f'üìñ –ß–∏—Ç–∞—é —Ñ–∞–π–ª: {json_path}')
    
    # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ (–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É)
    print('üîç –ü–∞—Ä—Å—é –¥–∞–Ω–Ω—ã–µ –æ —Ä–∏—Ç—É–∞–ª–∞—Ö –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è—Ö...')
    grouped_sharings = parse_ritual_data(json_path)
    
    if not grouped_sharings:
        print('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∏—Ç—É–∞–ª–∞—Ö')
        return
    
    total_sharings = sum(len(sharings) for sharings in grouped_sharings.values())
    print(f'‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(grouped_sharings)} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å {total_sharings} —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º–∏')
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LLM —Å–µ—Ä–≤–∏—Å –∑–∞—Ä–∞–Ω–µ–µ
    print('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é LLM —Å–µ—Ä–≤–∏—Å...')
    init_llm_service()
    
    # –°–æ–∑–¥–∞–µ–º –±—Ä–∏—Ñ—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    print('ü§ñ –°–æ–∑–¥–∞—é LLM-–±—Ä–∏—Ñ—ã –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...')
    results = []
    
    for (ritual_date, ritual_name, from_name), sharings in grouped_sharings.items():
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
        combined_sharing = "\n\n---\n\n".join(sharings)
        
        # –°–æ–∑–¥–∞–µ–º –±—Ä–∏—Ñ –≤—Å–µ–≥–¥–∞ (–¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
        combined_length = len(combined_sharing)
        
        brief = await create_brief(sharings)
        
        # –ï—Å–ª–∏ –±—Ä–∏—Ñ –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è, —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞
        if not brief and combined_sharing:
            # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞
            first_words = ' '.join(combined_sharing.split()[:10])
            if len(first_words) > 20:
                brief = f"–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞: {first_words}..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–¥–∏—é –ø—É—Ç–∏ –≥–µ—Ä–æ—è
        journey_stage = detect_hero_journey_stage(sharings)
        
        results.append({
            '–î–∞—Ç–∞': ritual_date,
            '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞': ritual_name,
            '–§–ò–û': from_name,
            '–°—Ç–∞–¥–∏—è –ø—É—Ç–∏ –≥–µ—Ä–æ—è': journey_stage,
            '–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ': combined_sharing,
            '–ê–Ω–∞–ª–∏–∑': brief
        })
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        if brief:
            stage_info = f" [{journey_stage}]" if journey_stage else ""
            print(f'  ‚úì {from_name}: —Å–æ–∑–¥–∞–Ω –±—Ä–∏—Ñ{stage_info} ({len(sharings)} —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π, {combined_length} —Å–∏–º–≤–æ–ª–æ–≤)')
        else:
            print(f'  ‚ö† {from_name}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–∏—Ñ ({len(sharings)} —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π, {combined_length} —Å–∏–º–≤–æ–ª–æ–≤)')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CSV
    csv_path = Path('data/ritual_meditation/ritual_meditations.csv')
    csv_path.parent.mkdir(parents=True, exist_ok=True)
    
    print(f'\nüíæ –°–æ—Ö—Ä–∞–Ω—è—é –≤ CSV: {csv_path}')
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏ CSV
    fieldnames = ['–î–∞—Ç–∞', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞', '–§–ò–û', '–°—Ç–∞–¥–∏—è –ø—É—Ç–∏ –≥–µ—Ä–æ—è', '–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ', '–ê–Ω–∞–ª–∏–∑']
    
    with open(csv_path, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(results)
    
    print(f'‚úÖ CSV —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {csv_path}')
    
    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    print('\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:')
    rituals = {}
    for row in results:
        key = f"{row['–î–∞—Ç–∞']} - {row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∏—Ç—É–∞–ª–∞']}"
        if key not in rituals:
            rituals[key] = []
        rituals[key].append(row['–§–ò–û'])
    
    for ritual, participants in rituals.items():
        print(f'\n  {ritual}:')
        print(f'    –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {len(participants)}')
        for p in sorted(set(participants)):
            count = participants.count(p)
            if count > 1:
                print(f'      - {p} ({count} —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π)')
            else:
                print(f'      - {p}')

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)."""
    asyncio.run(main_async())

if __name__ == "__main__":
    main()

