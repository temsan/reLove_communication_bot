# 🏗️ Архитектура AI-системы продаж и маркетинга

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM ECOSYSTEM                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐ │
│  │  Целевые каналы  │  │  Главный аккаунт │  │ Аккаунты         │ │
│  │  (мониторинг)    │  │  (продажи)       │  │ комментаторов    │ │
│  │                  │  │                  │  │ (комментарии)    │ │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘ │
│           │                     │                     │           │
│           └─────────────────────┼─────────────────────┘           │
│                                 │                                 │
│                    ┌────────────▼────────────┐                    │
│                    │   Telegram Bot API      │                    │
│                    │   (aiogram + Telethon)  │                    │
│                    └────────────┬────────────┘                    │
│                                 │                                 │
└─────────────────────────────────┼─────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────┐
│                      APPLICATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                    HANDLERS LAYER                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │ │
│  │  │ Comment      │  │ Sales        │  │ Education Group  │  │ │
│  │  │ Handler      │  │ Handler      │  │ Handler          │  │ │
│  │  └──────┬───────┘  └──────┬───────┘  └────────┬─────────┘  │ │
│  └─────────┼──────────────────┼──────────────────┼────────────┘ │
│            │                  │                  │              │
│  ┌─────────▼──────────────────▼──────────────────▼────────────┐ │
│  │                    SERVICES LAYER                          │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ COMMENTATOR SERVICES                                │ │ │
│  │  │ • ChannelMonitorService (сбор постов)              │ │ │
│  │  │ • CommentGenerationService (генерация)             │ │ │
│  │  │ • CommentSchedulerService (расписание)             │ │ │
│  │  │ • PersonalityService (адаптация)                   │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ SALES SERVICES                                      │ │ │
│  │  │ • ScriptService (загрузка скриптов)                │ │ │
│  │  │ • StrategySelectorService (выбор стратегии)        │ │ │
│  │  │ • SalesConversationService (ведение диалога)       │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ EDUCATION SERVICES                                  │ │ │
│  │  │ • EducationGroupService (управление группами)      │ │ │
│  │  │ • StudentBotService (поведение ботов)              │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ ACCOUNT SERVICES                                    │ │ │
│  │  │ • AccountSessionManager (управление сессиями)      │ │ │
│  │  │ • AccountSecurityService (безопасность)            │ │ │
│  │  │ • AccountManagementService (управление)            │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ COMMON SERVICES                                     │ │ │
│  │  │ • LLMService (OpenAI интеграция)                   │ │ │
│  │  │ • LoggingService (логирование)                     │ │ │
│  │  │ • HotReloadService (горячая перезагрузка)          │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  REPOSITORY LAYER                           │ │
│  │  • ChannelRepository                                        │ │
│  │  • PostRepository                                           │ │
│  │  • CommentatorRepository                                    │ │
│  │  • ScriptRepository                                         │ │
│  │  • ConversationRepository                                   │ │
│  │  • UserRepository                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────┐
│                      DATA LAYER                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              PostgreSQL Database                             │ │
│  │                                                              │ │
│  │  USERS & ACTIVITY:                                          │ │
│  │  • users, chats, user_activity_log                          │ │
│  │                                                              │ │
│  │  COMMENTATOR:                                               │ │
│  │  • telegram_channels, telegram_posts                        │ │
│  │  • commentator_accounts, account_personalities              │ │
│  │  • generated_comments, comment_schedules                    │ │
│  │  • direct_messages                                          │ │
│  │                                                              │ │
│  │  SALES:                                                     │ │
│  │  • sales_scripts, script_versions, script_triggers          │ │
│  │  • client_conversations, conversation_messages              │ │
│  │                                                              │ │
│  │  EDUCATION:                                                 │ │
│  │  • education_groups, student_bots, group_messages           │ │
│  │                                                              │ │
│  │  ACCOUNTS:                                                  │ │
│  │  • telegram_account_sessions, account_security_logs         │ │
│  │                                                              │ │
│  │  DIAGNOSTICS (существующие):                               │ │
│  │  • diagnostic_results, journey_progress, user_sessions      │ │
│  │                                                              │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Redis Cache (опционально)                       │ │
│  │  • Сессии аккаунтов (TTL 7 дней)                            │ │
│  │  • Кэш скриптов (TTL 24 часа)                               │ │
│  │  • Кэш промптов (TTL 1 час)                                 │ │
│  │  • Временные данные                                         │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────┐
│                    EXTERNAL SERVICES                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              OpenAI API                                      │ │
│  │  • Генерация summary (main_idea, keywords, tone)            │ │
│  │  • Генерация комментариев                                   │ │
│  │  • Анализ сообщений                                         │ │
│  │  • Выбор стратегии ответа                                  │ │
│  │  • Имитация диалогов                                        │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────┐
│                    ADMIN PANEL                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Flask Web Application                           │ │
│  │                                                              │ │
│  │  SECTIONS:                                                  │ │
│  │  • Dashboard (статистика, графики)                          │ │
│  │  • Accounts (управление аккаунтами)                         │ │
│  │  • Channels (управление каналами)                           │ │
│  │  • Scripts (редактор скриптов)                              │ │
│  │  • Conversations (история диалогов)                         │ │
│  │  • Groups (управление группами)                             │ │
│  │  • Logs (логи и история)                                    │ │
│  │  • Settings (системные параметры)                           │ │
│  │                                                              │ │
│  │  API ENDPOINTS:                                             │ │
│  │  • /api/accounts (CRUD)                                     │ │
│  │  • /api/channels (CRUD)                                     │ │
│  │  • /api/scripts (CRUD)                                      │ │
│  │  • /api/conversations (GET)                                 │ │
│  │  • /api/groups (CRUD)                                       │ │
│  │  • /api/stats (GET)                                         │ │
│  │  • /api/logs (GET)                                          │ │
│  │                                                              │ │
│  │  FRONTEND:                                                  │ │
│  │  • HTML/CSS/JavaScript                                      │ │
│  │  • Bootstrap для UI                                         │ │
│  │  • Charts.js для графиков                                   │ │
│  │                                                              │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Поток данных: Комментатор

```
Целевой канал
    │
    ▼
┌─────────────────────────────────┐
│ ChannelMonitorService           │
│ • Подключение к каналу          │
│ • Сбор новых постов             │
│ • Сохранение в БД               │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ TelegramPost (БД)               │
│ • chat_id, message_id           │
│ • text, media_urls              │
│ • created_at                    │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ LLMService                      │
│ • Анализ поста                  │
│ • Генерация summary             │
│ • {main_idea, keywords, tone}   │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ CommentGenerationService        │
│ • Выбор аккаунта комментатора   │
│ • Генерация комментария         │
│ • Адаптация под личность        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ GeneratedComment (БД)           │
│ • post_id, account_id           │
│ • text, status=pending          │
│ • created_at                    │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ CommentSchedulerService         │
│ • Проверка расписания           │
│ • Отправка комментария          │
│ • Обновление статуса            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ Telegram API                    │
│ • Отправка комментария          │
│ • Получение ответов             │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ GeneratedComment (БД)           │
│ • status=sent                   │
│ • sent_at, engagement_metrics   │
└─────────────────────────────────┘
```

---

## Поток данных: Продажи

```
Входящее сообщение от клиента
    │
    ▼
┌─────────────────────────────────┐
│ SalesHandler                    │
│ • Получение сообщения           │
│ • Определение пользователя      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ LLMService                      │
│ • Анализ сообщения              │
│ • Генерация summary             │
│ • Определение интонации         │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ StrategySelectorService         │
│ • Оценка соответствия скрипту   │
│ • Выбор стратегии               │
│ • script_80 или free_20         │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ ScriptService                   │
│ • Загрузка скрипта из БД        │
│ • Получение следующего шага     │
│ • Проверка триггеров            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ SalesConversationService        │
│ • Генерация ответа              │
│ • Адаптация под стратегию       │
│ • Сохранение в БД               │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ ClientConversation (БД)         │
│ • user_id, script_id            │
│ • stage, strategy               │
│ • messages                      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ Telegram API                    │
│ • Отправка ответа               │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ Проверка триггера               │
│ • Согласие клиента?             │
│ • Готовность к группе?          │
└────────────┬────────────────────┘
             │
             ├─ ДА ──▶ EducationGroupService
             │        (создание группы)
             │
             └─ НЕТ ──▶ Продолжение диалога
```

---

## Поток данных: Группа учеников

```
Триггер (согласие клиента)
    │
    ▼
┌─────────────────────────────────┐
│ EducationGroupService           │
│ • Создание Telegram группы      │
│ • Добавление клиента            │
│ • Добавление ботов-учеников     │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ EducationGroup (БД)             │
│ • chat_id, client_id            │
│ • created_at, status=active     │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ SalesConversationService        │
│ • Загрузка Скрипта №2           │
│ • Запуск сценария обучения      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ Главный аккаунт                 │
│ • Приветственное сообщение      │
│ • Рассказ о проекте             │
│ • Задания клиенту               │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ StudentBotService               │
│ • Реакция на задание            │
│ • Наивные вопросы               │
│ • Показ успеха                  │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ EducationGroupHandler           │
│ • Получение сообщения клиента   │
│ • Анализ через LLM              │
│ • Выбор ответчика               │
│ • Отправка ответа               │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ GroupMessage (БД)               │
│ • group_id, user_id             │
│ • text, sender_type             │
│ • created_at                    │
└─────────────────────────────────┘
```

---

## Управление аккаунтами

```
┌─────────────────────────────────────────────────────────┐
│         AccountManagementService                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────────────┐ │
│  │ Регистрация аккаунта                             │ │
│  │ • Ввод номера телефона                           │ │
│  │ • Авторизация в Telegram                         │ │
│  │ • Создание сессии Telethon                       │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ AccountSecurityService                           │ │
│  │ • Шифрование номера телефона                     │ │
│  │ • Шифрование session_data                        │ │
│  │ • Хранение в БД                                  │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ TelegramAccountSession (БД)                      │ │
│  │ • account_id, phone (encrypted)                  │ │
│  │ • session_data (encrypted)                       │ │
│  │ • is_active, created_at                          │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ PersonalityService                               │ │
│  │ • Создание личности аккаунта                     │ │
│  │ • Стиль, тон, интересы                           │ │
│  │ • Словарь и фразы                                │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ AccountPersonality (БД)                          │ │
│  │ • account_id, name                               │ │
│  │ • personality (JSON)                             │ │
│  │ • is_active                                      │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ AccountSessionManager                            │
│  │ • Восстановление сессии                          │
│  │ • Создание TelegramClient                        │
│  │ • Кэширование в Redis                            │ │
│  └────────────────┬─────────────────────────────────┘ │
│                   │                                    │
│  ┌────────────────▼─────────────────────────────────┐ │
│  │ Готовый аккаунт                                  │ │
│  │ • Может отправлять комментарии                   │ │
│  │ • Может вести диалоги                            │ │
│  │ • Может быть ботом-учеником                      │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Горячая перезагрузка скриптов

```
Администратор редактирует скрипт в админ-панели
    │
    ▼
┌─────────────────────────────────┐
│ Flask API                       │
│ POST /api/scripts/<id>          │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ ScriptRepository                │
│ • Обновление в БД              │
│ • Увеличение версии            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ SalesScript (БД)                │
│ • version += 1                  │
│ • updated_at = now()            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ HotReloadService                │
│ • Обнаружение изменения         │
│ • Инвалидация кэша              │
│ • Отправка сигнала              │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ ScriptService._scripts_cache    │
│ • Удаление старой версии        │
│ • Кэш очищен                    │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ При следующем использовании     │
│ • load_script() загружает новую  │
│ • Кэш обновляется               │
│ • Бот продолжает работать        │
└─────────────────────────────────┘
```

---

## Система стратегий (80/20)

```
Входящее сообщение от клиента
    │
    ▼
┌─────────────────────────────────┐
│ LLMService.analyze_message()    │
│ • Анализ текста                 │
│ • Определение интонации         │
│ • Оценка соответствия скрипту   │
│ • script_fit_score (0-1)        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ StrategySelectorService         │
│ • if script_fit_score > 0.7:    │
│   return "script_80"            │
│ • else:                         │
│   return "free_20"              │
└────────────┬────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
    ▼                 ▼
┌──────────────┐  ┌──────────────┐
│ script_80    │  │ free_20      │
│              │  │              │
│ 80% скрипт   │  │ 20% скрипт   │
│ 20% свобода  │  │ 80% свобода  │
│              │  │              │
│ • Получить   │  │ • Свободный  │
│   ответ из   │  │   диалог     │
│   скрипта    │  │ • Элементы   │
│ • Адаптировать│  │   скрипта    │
│   под тон    │  │ • Проработка │
│ • Отправить  │  │   боли       │
└──────────────┘  └──────────────┘
    │                 │
    └────────┬────────┘
             │
             ▼
┌─────────────────────────────────┐
│ Ответ клиенту                   │
│ • Персонализированный           │
│ • Адаптированный под стратегию  │
│ • Сохранен в БД                 │
└─────────────────────────────────┘
```

