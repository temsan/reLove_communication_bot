# 🔄 Диаграмма процесса импорта пользователей

## Общий процесс

```
┌─────────────────────────────────────────────────────────────┐
│                    ИМПОРТ ПОЛЬЗОВАТЕЛЕЙ                      │
│                   ИЗ КАНАЛОВ RELOVE                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. АВТОРИЗАЦИЯ (один раз)                                   │
│  python scripts/test_telethon_connection.py                  │
│                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │ Телефон  │ -> │   Код    │ -> │  Сессия  │              │
│  └──────────┘    └──────────┘    └──────────┘              │
│                                        │                     │
│                                        ▼                     │
│                              relove_bot.session              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. ПОИСК КАНАЛОВ                                            │
│  python scripts/quick_channel_list.py                        │
│                                                              │
│  ┌──────────────────────────────────────────────┐           │
│  │  Сканирование всех диалогов                  │           │
│  │  Фильтр: "relove" или "релов" в названии     │           │
│  └──────────────────────────────────────────────┘           │
│                       │                                      │
│                       ▼                                      │
│  ┌─────────────────────────────────────────────┐            │
│  │ Найденные каналы:                           │            │
│  │ • reLove Community (@reloveinfo)            │            │
│  │ • reLove Chat (@relovechat)                 │            │
│  │ • Путь Героя reLove (no username)          │            │
│  └─────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. ИМПОРТ ПОЛЬЗОВАТЕЛЕЙ                                     │
│  python scripts/fill_profiles_from_channels.py --all         │
│                                                              │
│  Для каждого канала:                                         │
│  ┌──────────────────────────────────────────────┐           │
│  │  3.1. Получение участников                   │           │
│  │       iter_participants(channel)             │           │
│  └──────────────────────────────────────────────┘           │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────┐           │
│  │  3.2. Фильтрация                             │           │
│  │       • Только User (не боты)                │           │
│  │       • Активные аккаунты                    │           │
│  └──────────────────────────────────────────────┘           │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────┐           │
│  │  3.3. Сохранение в БД                        │           │
│  │       • Проверка существования               │           │
│  │       • Добавление новых                     │           │
│  │       • Обновление существующих              │           │
│  └──────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. ЗАПОЛНЕНИЕ ПРОФИЛЕЙ (опционально)                        │
│  --no-fill: пропустить этот шаг                             │
│                                                              │
│  Для каждого пользователя:                                   │
│  ┌──────────────────────────────────────────────┐           │
│  │  4.1. ProfileService.analyze_profile()       │           │
│  └──────────────────────────────────────────────┘           │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────┐           │
│  │  4.2. LLM анализ                             │           │
│  │       • Определение психотипа                │           │
│  │       • Анализ интересов                     │           │
│  │       • Генерация summary                    │           │
│  └──────────────────────────────────────────────┘           │
│                       │                                      │
│                       ▼                                      │
│  ┌──────────────────────────────────────────────┐           │
│  │  4.3. Сохранение профиля                     │           │
│  │       • markers['summary']                   │           │
│  │       • markers['relove_context']            │           │
│  └──────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. СТАТИСТИКА                                               │
│                                                              │
│  ┌──────────────────────────────────────────────┐           │
│  │  Channels processed: 3                       │           │
│  │  Users found: 1250                           │           │
│  │  Users added: 1100                           │           │
│  │  Users updated: 150                          │           │
│  │  Profiles filled: 1250                       │           │
│  │  Errors: 0                                   │           │
│  └──────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

## Детальный процесс обработки канала

```
┌─────────────────────────────────────────────────────────────┐
│                  ОБРАБОТКА ОДНОГО КАНАЛА                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │  Получить канал  │
                  │  по username/ID  │
                  └──────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ Проверить тип    │
                  │ канала           │
                  └──────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Broadcast       │    │  Группа/         │
    │  канал           │    │  Супергруппа     │
    └──────────────────┘    └──────────────────┘
                │                       │
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Только админы   │    │  Все участники   │
    │  (ограничено)    │    │  (полный доступ) │
    └──────────────────┘    └──────────────────┘
                │                       │
                └───────────┬───────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ iter_participants│
                  │ (limit=10000)    │
                  └──────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ Фильтр: не боты  │
                  └──────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ Прогресс-бар     │
                  │ (tqdm)           │
                  └──────────────────┘
                            │
                            ▼
            ┌───────────────────────────┐
            │  Для каждого участника:   │
            │                           │
            │  1. save_user_to_db()     │
            │  2. fill_user_profile()   │
            │  3. asyncio.sleep(0.1)    │
            └───────────────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ Статистика       │
                  │ по каналу        │
                  └──────────────────┘
```

## Обработка пользователя

```
┌─────────────────────────────────────────────────────────────┐
│              ОБРАБОТКА ОДНОГО ПОЛЬЗОВАТЕЛЯ                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ TelethonUser     │
                  │ (из API)         │
                  └──────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ Проверка в БД    │
                  │ SELECT * WHERE   │
                  │ id = user_id     │
                  └──────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Существует      │    │  Не существует   │
    └──────────────────┘    └──────────────────┘
                │                       │
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Обновить:       │    │  Создать:        │
    │  • username      │    │  • id            │
    │  • first_name    │    │  • username      │
    │  • last_name     │    │  • first_name    │
    │  • is_active     │    │  • last_name     │
    └──────────────────┘    │  • gender        │
                │           │  • is_active     │
                │           └──────────────────┘
                │                       │
                └───────────┬───────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ COMMIT           │
                  └──────────────────┘
                            │
                            ▼
            ┌───────────────────────────┐
            │  Заполнить профиль?       │
            │  (если не --no-fill)      │
            └───────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  Да              │    │  Нет             │
    └──────────────────┘    └──────────────────┘
                │                       │
                ▼                       │
    ┌──────────────────┐                │
    │ ProfileService   │                │
    │ .analyze_profile │                │
    └──────────────────┘                │
                │                       │
                ▼                       │
    ┌──────────────────┐                │
    │ LLM анализ       │                │
    └──────────────────┘                │
                │                       │
                ▼                       │
    ┌──────────────────┐                │
    │ Сохранить        │                │
    │ markers          │                │
    └──────────────────┘                │
                │                       │
                └───────────┬───────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │ stats.update()   │
                  └──────────────────┘
```

## Варианты использования

### Вариант 1: Быстрый импорт

```
┌─────────────────────────────────────────┐
│  --all --no-fill                        │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Найти все каналы reLove                │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Получить участников                    │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Сохранить в БД                         │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  ПРОПУСТИТЬ заполнение профилей         │
└─────────────────────────────────────────┘
            │
            ▼
        ГОТОВО
    (быстро: ~5-10 мин для 1000 юзеров)
```

### Вариант 2: Полный импорт

```
┌─────────────────────────────────────────┐
│  --all                                  │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Найти все каналы reLove                │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Получить участников                    │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Сохранить в БД                         │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Заполнить профили через LLM            │
└─────────────────────────────────────────┘
            │
            ▼
        ГОТОВО
    (медленно: ~10-20 мин для 1000 юзеров)
```

### Вариант 3: Конкретный канал

```
┌─────────────────────────────────────────┐
│  --channel @reloveinfo                  │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Получить канал по username             │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Получить участников                    │
└─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────┐
│  Обработать (сохранить + профили)       │
└─────────────────────────────────────────┘
            │
            ▼
        ГОТОВО
```

## Обработка ошибок

```
┌─────────────────────────────────────────┐
│  Любая операция                         │
└─────────────────────────────────────────┘
            │
            ▼
    ┌───────────────┐
    │  try:         │
    │  операция     │
    └───────────────┘
            │
    ┌───────┴───────┐
    │               │
    ▼               ▼
┌────────┐    ┌──────────┐
│ Success│    │  Error   │
└────────┘    └──────────┘
    │               │
    │               ▼
    │      ┌──────────────┐
    │      │ logger.error │
    │      └──────────────┘
    │               │
    │               ▼
    │      ┌──────────────┐
    │      │ stats.errors │
    │      │ += 1         │
    │      └──────────────┘
    │               │
    │               ▼
    │      ┌──────────────┐
    │      │ Продолжить   │
    │      │ работу       │
    │      └──────────────┘
    │               │
    └───────┬───────┘
            │
            ▼
    Следующий элемент
```

## Rate Limiting

```
┌─────────────────────────────────────────┐
│  Обработка пользователей                │
└─────────────────────────────────────────┘
            │
            ▼
    ┌───────────────┐
    │  Пользователь │
    │  1            │
    └───────────────┘
            │
            ▼
    ┌───────────────┐
    │ asyncio.sleep │
    │ (0.1 сек)     │
    └───────────────┘
            │
            ▼
    ┌───────────────┐
    │  Пользователь │
    │  2            │
    └───────────────┘
            │
            ▼
    ┌───────────────┐
    │ asyncio.sleep │
    │ (0.1 сек)     │
    └───────────────┘
            │
            ▼
         ...

┌─────────────────────────────────────────┐
│  Обработка каналов                      │
└─────────────────────────────────────────┘
            │
            ▼
    ┌───────────────┐
    │  Канал 1      │
    └───────────────┘
            │
            ▼
    ┌───────────────┐
    │ asyncio.sleep │
    │ (2 сек)       │
    └───────────────┘
            │
            ▼
    ┌───────────────┐
    │  Канал 2      │
    └───────────────┘
            │
            ▼
         ...
```

---

**Визуализация процесса импорта пользователей из каналов reLove** 🔄
