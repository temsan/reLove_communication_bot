# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

‚úÖ **–ö–æ–¥ –≥–æ—Ç–æ–≤:**
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—è –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª–µ–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ (hero_stage, metaphysics, streams)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

‚úÖ **–ë–î –≥–æ—Ç–æ–≤–∞:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 2889
- –° –ø—Ä–æ—Ñ–∏–ª—è–º–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç): 318
- –ì–æ—Ç–æ–≤—ã –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é: 2889

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telethon

---

## –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telethon

### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
python scripts/test_telethon_session.py
```

**–í–≤–µ–¥–∏—Ç–µ:**
1. –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: +79991234567)
2. –ö–æ–¥ –∏–∑ Telegram
3. –ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Connecting to Telegram...
‚úÖ Connected!
Logged in as: –ò–º—è (@username)
Disconnected
```

---

### –í–∞—Ä–∏–∞–Ω—Ç B: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç

```bash
python scripts/profiles/fill_profiles_from_channels.py --all
```

**–í–≤–µ–¥–∏—Ç–µ:**
1. –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. –ö–æ–¥ –∏–∑ Telegram
3. –ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)

–ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```bash
python scripts/profiles/fill_profiles_from_channels.py --all
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**

1. **–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤** (~10 —Å–µ–∫)
   ```
   Found 5 reLove channels/groups:
     - reLove Community (@relove)
     - reLove Discussions (@relove_chat)
     ...
   ```

2. **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö** (~5-10 –º–∏–Ω)
   ```
   STEP 1: Collecting data from all channels
   Collecting data from: reLove Community
   Found 500 participants
   Collected 1000 messages
   ...
   ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (~30-60 –º–∏–Ω)
   ```
   STEP 2: Processing all users with accumulated data
   Processing 2500 accumulated users
   User 123456 (@user1): 3 channels, 50 posts
   ‚úÖ Filled profile for user 123456
   ‚úÖ Determined hero_stage: –ó–æ–≤ –∫ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—é
   ‚úÖ Created metaphysics
   ‚úÖ Determined streams: –ü—É—Ç—å –ì–µ—Ä–æ—è, –ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ
   ...
   ```

4. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
   ```
   STATISTICS
   ==========================================================
   Channels processed: 5
   Users found (total): 2500
   Users found (unique): 2400
   Duplicates found: 100
   Users added: 50
   Users updated: 2350
   Profiles filled (new): 2082
   Profiles refilled (old format): 318
   Errors: 0
   ==========================================================
   ```

---

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

```bash
python scripts/check_db_state.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
DATABASE STATE
============================================================
Total users: 2889
With profile: 2500+
V2 profiles (new format): 2500+
Old format (needs refill): 0
============================================================
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
python scripts/testing/test_profile_enrichment.py --user 123456789
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
User: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (@ivan)
Current profile: –ê–∫—Ç–∏–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞...

1. Determining journey stage...
‚úÖ Hero stage: –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞

2. Creating metaphysical profile...
‚úÖ Metaphysics:
   Planet: –ú–∞—Ä—Å
   Karma: –£—á–∏—Ç—Å—è –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —ç–Ω–µ—Ä–≥–∏—é –≤ —Å–æ–∑–∏–¥–∞–Ω–∏–µ
   Balance: +2

3. Determining streams...
‚úÖ Streams: –ü—É—Ç—å –ì–µ—Ä–æ—è, –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¢–µ–Ω–∏

‚úÖ User updated in database
```

---

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ

```bash
# –í—Å–µ –∫–∞–Ω–∞–ª—ã reLove
python scripts/profiles/fill_profiles_from_channels.py --all

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª
python scripts/profiles/fill_profiles_from_channels.py --channel @relove

# –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
python scripts/profiles/fill_profiles_from_channels.py --all --limit 100
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ

```bash
# –¢–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç –±–µ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π
python scripts/profiles/fill_profiles_from_channels.py --all --no-fill

# –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã)
python scripts/profiles/fill_profiles_from_channels.py --all --incremental

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤
python scripts/profiles/fill_profiles_from_channels.py --list-channels
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞

### –õ–æ–≥–∏

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `logs/fill_profiles_from_channels.log`

```bash
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f logs/fill_profiles_from_channels.log

# Windows
Get-Content logs\fill_profiles_from_channels.log -Wait
```

---

### –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ –ë–î

–í–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å:

```bash
# –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
while true; do python scripts/check_db_state.py; sleep 300; done

# Windows PowerShell
while ($true) { python scripts/check_db_state.py; Start-Sleep -Seconds 300 }
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Please enter your phone"

**–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Å—Å–∏—è Telethon —É—Å—Ç–∞—Ä–µ–ª–∞ –∏–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é: `rm relove_bot.session`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞ –∏ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

---

### –ü—Ä–æ–±–ª–µ–º–∞: "Connection timeout"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Telegram

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ VPN
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 5-10 –º–∏–Ω—É—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å

---

### –ü—Ä–æ–±–ª–µ–º–∞: "Rate limit exceeded"

**–ü—Ä–∏—á–∏–Ω–∞:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã
2. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è - –ø–æ–¥–æ–∂–¥–∞—Ç—å 1 —á–∞—Å
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å `--limit 100` –¥–ª—è –º–µ–Ω—å—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏

---

### –ü—Ä–æ–±–ª–µ–º–∞: "LLM API error"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å OpenRouter API

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ OpenRouter
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á –≤ .env
3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å

---

## –°—Ç–æ–∏–º–æ—Å—Ç—å

### OpenAI API (gpt-4o-mini)

**–ù–∞ 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
- –°–æ–∑–¥–∞–Ω–∏–µ profile: ~500 —Ç–æ–∫–µ–Ω–æ–≤ = $0.00015
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ hero_stage: ~50 —Ç–æ–∫–µ–Ω–æ–≤ = $0.000015
- –°–æ–∑–¥–∞–Ω–∏–µ metaphysics: ~200 —Ç–æ–∫–µ–Ω–æ–≤ = $0.00006
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ streams: ~100 —Ç–æ–∫–µ–Ω–æ–≤ = $0.00003
- **–ò—Ç–æ–≥–æ:** ~$0.00025 (0.025 —Ü–µ–Ω—Ç–∞)

**–ù–∞ 2500 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- **–ò—Ç–æ–≥–æ:** ~$0.625 (62.5 —Ü–µ–Ω—Ç–∞)

---

## –ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
python scripts/check_db_state.py
python scripts/testing/test_profile_enrichment.py --all
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞

–î–æ–±–∞–≤–∏—Ç—å –≤ `relove_bot/services/message_orchestrator.py`:

```python
if user.profile:
    system_prompt += f"\n\n–ü–†–û–§–ò–õ–¨:\n{user.profile}\n"

if user.hero_stage:
    system_prompt += f"\n–≠–¢–ê–ü –ü–£–¢–ò: {user.hero_stage.value}\n"

if user.metaphysics:
    system_prompt += f"\n–ú–ï–¢–ê–§–ò–ó–ò–ö–ê:\n"
    system_prompt += f"- –ü–ª–∞–Ω–µ—Ç–∞: {user.metaphysics['planet']}\n"
    system_prompt += f"- –ë–∞–ª–∞–Ω—Å: {user.metaphysics['light_dark_balance']}\n"

if user.streams:
    system_prompt += f"\n–ü–û–¢–û–ö–ò: {', '.join(user.streams)}\n"
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –≤ cron –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

```bash
# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * cd /path/to/project && python scripts/profiles/fill_profiles_from_channels.py --all --incremental
```

---

## –ò—Ç–æ–≥–∏

‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤  
‚úÖ –ë–î –≥–æ—Ç–æ–≤–∞  
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã  
‚úÖ –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã  
‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telethon  

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ! üöÄ
