# –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ –ø—Å–∏—Ö–æ–ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤

## üìä –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π

### 1. **–û–Ω–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É:

1. **ProfileUpdateMiddleware** –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
2. –û–±–Ω–æ–≤–ª—è–µ—Ç `last_seen_date` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ `UserActivityLog` (—Ç–∏–ø: message, command, callback_query –∏ —Ç.–¥.)
4. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è:**
   - –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç–∞—Ä—à–µ **7 –¥–Ω–µ–π** ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∏–º–µ–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### 2. **–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è**

–ö–æ–≥–¥–∞ –ø—Ä–æ—Ñ–∏–ª—å —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `_update_profile_background()` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ProfileRotationService` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è:
   - `profile_summary` - —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ–∑—é–º–µ
   - `psych_profile` - –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
   - `markers['profile_updated_at']` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - `gender` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–ª
   - `streams` - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–æ—Ç–æ–∫–∏ reLove

### 3. **–ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π (–∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞)**

–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `profile_rotation_task()`:

1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ **24 —á–∞—Å–∞**
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ö –ø—Ä–æ—Ñ–∏–ª–∏ —á–µ—Ä–µ–∑ `ProfileRotationService`
4. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ—Ñ–∏–ª—è

```
–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (ProfileService.analyze_profile)
    ‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    ‚Üì
–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è (ProfileUpdateMiddleware)
    ‚Üì
–ï—Å–ª–∏ > 7 –¥–Ω–µ–π ‚Üí –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    ‚Üì
–ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ ‚Üí –ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
```

## üìù –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è)
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∏–º—è, username, –ø–æ–ª)
- ‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–æ—Ç–æ–∫–∏
- ‚úÖ –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)

### –ü—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (–∫–∞–∂–¥—ã–µ 7+ –¥–Ω–µ–π)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ –ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏

### –ü—Ä–∏ –ø–ª–∞–Ω–æ–≤–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ (–∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–µ—Ä–µ–∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤

## üéØ –¢—Ä–∏–≥–≥–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

| –¢—Ä–∏–≥–≥–µ—Ä | –£—Å–ª–æ–≤–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|---------|---------|
| **–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π | –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å |
| **–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** | –ü—Ä–æ—Ñ–∏–ª—å > 7 –¥–Ω–µ–π | –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ |
| **–ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞** | –ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è | –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ |
| **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** | –°–æ–æ–±—â–µ–Ω–∏–µ/–∫–æ–º–∞–Ω–¥–∞ | –û–±–Ω–æ–≤–∏—Ç—å last_seen_date |

## üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è (—Ç–∞–±–ª–∏—Ü–∞ `users`)
```python
- id: int (Telegram user ID)
- username: str
- first_name: str
- last_name: str
- profile_summary: str (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ–∑—é–º–µ)
- psych_profile: str (–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å)
- gender: GenderEnum (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–ª)
- streams: List[str] (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–æ—Ç–æ–∫–∏)
- markers: dict (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è profile_updated_at)
- last_seen_date: datetime (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç)
- is_active: bool (–∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ç–∞–±–ª–∏—Ü–∞ `user_activity_logs`)
```python
- user_id: int
- activity_type: str (message, command, callback_query, photo, document)
- details: dict (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- timestamp: datetime (–∫–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
- **–ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è:** –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
- **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è –ª–æ–≥–æ–≤:** –ö–∞–∂–¥—ã–µ 7 –¥–Ω–µ–π (–ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π)

### –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ
```python
# relove_bot/middlewares/profile_update.py
if age > timedelta(days=7):  # ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π

# relove_bot/tasks/background_tasks.py
await asyncio.sleep(86400)  # ‚Üê 24 —á–∞—Å–∞ (86400 —Å–µ–∫—É–Ω–¥)
```

## üìä –ü—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. ProfileService —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
3. –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
4. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø—Ä–æ—Ñ–∏–ª—å 10 –¥–Ω–µ–π)
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. ProfileUpdateMiddleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è
3. –ü—Ä–æ—Ñ–∏–ª—å > 7 –¥–Ω–µ–π ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
4. ProfileRotationService –ø–µ—Ä–µ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
6. –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è
```
1. –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è profile_rotation_task()
2. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ö –ø—Ä–æ—Ñ–∏–ª–∏ —á–µ—Ä–µ–∑ ProfileRotationService
4. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```bash
Get-Content logs/bot.log | Select-String "profile"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î
```sql
SELECT id, username, profile_summary, markers->>'profile_updated_at' as updated_at
FROM users
ORDER BY updated_at DESC;
```

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –¢–µ–∫—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- ‚úÖ –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
- ‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- üîÑ –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à Redis –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
- üîÑ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
- üîÑ –£–º–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üîÑ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
