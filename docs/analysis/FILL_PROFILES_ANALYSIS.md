# –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ fill_profiles

## üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –§–∞–π–ª—ã:
1. **scripts/fill_profiles.py** - CLI —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
2. **relove_bot/services/profile_rotation_service.py** - —Å–µ—Ä–≤–∏—Å —Ä–æ—Ç–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
3. **scripts/fill_profiles_llm.py** - —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–∫—Ä–∏–ø—Ç —Å LLM
4. **scripts/simple_fill_profiles.py** - —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **ProfileRotationService - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.1: –ñ—ë—Å—Ç–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª–æ–≥–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```python
logs = await self.get_recent_logs(user.id, limit=50)
if not logs:
    logger.info(f"No activity logs for user {user.id}, skipping")
    self.stats['skipped'] += 1
    return
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ª–æ–≥–æ–≤ (–Ω–æ–≤—ã–µ/–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å fallback-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ª–æ–≥–æ–≤

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.2: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```python
# –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–∏–¥–µ–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
query = select(User).where(
    and_(
        User.is_active == True,
        User.last_seen_date >= thirty_days_ago
    )
)
# –ó–∞—Ç–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ Python –ø–æ markers['profile_updated_at']
```
**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç—å
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ JSON-–ø–æ–ª—é –≤ Python –≤–º–µ—Å—Ç–æ SQL
- –£ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π last_seen_date –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã —Å JSONB –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ PostgreSQL

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.3: –•—Ä—É–ø–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ LLM
```python
for line in analysis.split('\n'):
    line = line.strip()
    if line.startswith("SUMMARY:"):
        summary = line.replace("SUMMARY:", "").strip()
```
**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ù–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç
- –ü–∞–¥–∞–µ—Ç –µ—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å structured output –∏–ª–∏ –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.4: –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º
```python
posts = await telegram_service.get_user_posts(user.id, limit=10)
analysis = await llm_service.analyze_text(prompt, max_tokens=800)
```
**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–º–µ–¥–ª–µ–Ω–Ω–æ)
- –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, —Ç–∞–π–º–∞—É—Ç—ã, retry, –∫—ç—à

#### –ü—Ä–æ–±–ª–µ–º–∞ 1.5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç–∏
```python
await self.session.commit()  # –ö–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –Ω–µ—Ç batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏
**–†–µ—à–µ–Ω–∏–µ**: Batch commits

### 2. **fill_profiles.py - –ø—Ä–æ–±–ª–µ–º—ã CLI**

#### –ü—Ä–æ–±–ª–µ–º–∞ 2.1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
```python
for user in batch:
    try:
        await service.update_user_profile(user)
        pbar.update(1)
    except Exception as e:
        logger.error(f"Error updating user {user.id}: {e}")
        pbar.update(1)
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è —Å —Å–µ—Ä–≤–∏—Å–æ–º
**–†–µ—à–µ–Ω–∏–µ**: –í—ã–Ω–µ—Å—Ç–∏ –≤ —Å–µ—Ä–≤–∏—Å

#### –ü—Ä–æ–±–ª–µ–º–∞ 2.2: –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM, –Ω–µ—Ç –æ–ø—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ --strategy (llm/basic/hybrid)

### 3. **fill_profiles_llm.py - —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥**

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –•–∞—Ä–¥–∫–æ–¥ –ø—É—Ç–∏ –∫ –ë–î: `'sqlite+aiosqlite:///path_to_your_database.db'`
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥
- –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑–æ–π

**–†–µ—à–µ–Ω–∏–µ**: –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å

---

## ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CLI: scripts/fill_profiles.py        ‚îÇ
‚îÇ   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏          ‚îÇ
‚îÇ   - –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä                        ‚îÇ
‚îÇ   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Orchestrator: ProfileFillOrchestrator ‚îÇ
‚îÇ   - –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏                     ‚îÇ
‚îÇ   - Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞                     ‚îÇ
‚îÇ   - –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è                      ‚îÇ
‚îÇ   - Retry –ª–æ–≥–∏–∫–∞                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Strategy:  ‚îÇ  ‚îÇ  Strategy:  ‚îÇ
‚îÇ  LLMBased   ‚îÇ  ‚îÇ  BasicFill  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ               ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Repository: UserProfileRepository     ‚îÇ
‚îÇ   - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏                       ‚îÇ
‚îÇ   - Batch updates                       ‚îÇ
‚îÇ   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

1. **BasicStrategy** - –±—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ (—Ç–µ–∫—É—â–∏–π simple_fill_profiles.py)
2. **LLMStrategy** - –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM (—Ç–µ–∫—É—â–∏–π ProfileRotationService)
3. **HybridStrategy** - LLM –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏, basic –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
4. **IncrementalStrategy** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö

---

## üéØ –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –§–∞–∑–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- [ ] UserProfileRepository - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
- [ ] ProfileFillStrategy (ABC) - –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- [ ] ProfileFillOrchestrator - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

### –§–∞–∑–∞ 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- [ ] BasicFillStrategy - –±—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
- [ ] LLMFillStrategy - –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
- [ ] HybridFillStrategy - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (asyncio.gather)
- [ ] Batch commits
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ LLM
- [ ] Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff

### –§–∞–∑–∞ 4: –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
- [ ] Structured output –¥–ª—è LLM (JSON schema)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Pydantic)
- [ ] Graceful degradation
- [ ] –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –§–∞–∑–∞ 5: CLI —É–ª—É—á—à–µ–Ω–∏—è
- [ ] –§–ª–∞–≥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- [ ] Dry-run —Ä–µ–∂–∏–º
- [ ] Resume capability (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

```python
@dataclass
class ProfileFillMetrics:
    total_users: int
    processed: int
    updated: int
    skipped: int
    errors: int
    
    # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
    updated_by_llm: int
    updated_by_basic: int
    updated_by_hybrid: int
    
    # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    avg_time_per_user: float
    total_time: float
    llm_calls: int
    llm_tokens_used: int
    
    # –ö–∞—á–µ—Å—Ç–≤–æ
    profiles_with_summary: int
    profiles_with_streams: int
    profiles_with_markers: int
```

---

## üîß –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

```bash
# –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π
python scripts/fill_profiles.py --strategy basic --all

# LLM –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
python scripts/fill_profiles.py --strategy llm --with-activity-only

# –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (LLM –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ, basic –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö)
python scripts/fill_profiles.py --strategy hybrid --all --batch-size 20

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π (>7 –¥–Ω–µ–π)
python scripts/fill_profiles.py --strategy llm --outdated-only --days 7

# Dry-run –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
python scripts/fill_profiles.py --strategy hybrid --all --dry-run

# –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
python scripts/fill_profiles.py --resume --checkpoint-file /tmp/fill_checkpoint.json

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
python scripts/fill_profiles.py --strategy hybrid --all --workers 5
```

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```python
# –ö—ç—à –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö—ç—à–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
cache_key = hashlib.md5(prompt.encode()).hexdigest()
if cached := await redis.get(f"llm_profile:{cache_key}"):
    return json.loads(cached)
```

### 2. Rate limiting –¥–ª—è LLM
```python
from aiolimiter import AsyncLimiter
rate_limiter = AsyncLimiter(10, 60)  # 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

async with rate_limiter:
    result = await llm_service.analyze_text(...)
```

### 3. Checkpoint —Å–∏—Å—Ç–µ–º–∞
```python
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–µ N –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
if processed % checkpoint_interval == 0:
    await save_checkpoint({
        'last_user_id': user.id,
        'processed': processed,
        'timestamp': datetime.now()
    })
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
```python
# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana
profile_fill_duration.observe(duration)
profile_fill_errors.inc()
profile_fill_success.inc()
```

---

## üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å):
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å BasicFillStrategy (—É–∂–µ –µ—Å—Ç—å –≤ simple_fill_profiles.py)
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ProfileRotationService:
   - –£–±—Ä–∞—Ç—å –∂—ë—Å—Ç–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª–æ–≥–æ–≤
   - –£–ª—É—á—à–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ LLM –æ—Ç–≤–µ—Ç–æ–≤
   - –î–æ–±–∞–≤–∏—Ç—å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
3. –°–æ–∑–¥–∞—Ç—å UserProfileRepository –¥–ª—è SQL –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. –°–æ–∑–¥–∞—Ç—å ProfileFillOrchestrator
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å HybridStrategy
6. –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
7. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ rate limiting
8. Checkpoint —Å–∏—Å—Ç–µ–º–∞
9. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
