# Руководство по инкрементальному обновлению профилей

## Концепция

Инкрементальное обновление позволяет обновлять профили пользователей только на основе **новых постов**, не перегенерируя весь профиль заново.

## Режимы работы

### 1. Полное заполнение (Full Fill)

**Когда используется:**
- Первый запуск (профиль пуст)
- `profile_summary` или `psychological_summary` отсутствуют

**Что делает:**
- Собирает ВСЕ посты из всех каналов
- Получает bio и фото профиля
- Генерирует полный психологический анализ
- Сохраняет фото в БД

**Команда:**
```bash
python scripts/profiles/fill_profiles_from_channels.py --all
```

### 2. Инкрементальное обновление (Incremental Update)

**Когда используется:**
- Профиль уже существует
- Есть новые посты с момента последнего обновления

**Что делает:**
- Собирает только НОВЫЕ посты (после `last_seen_date`)
- Генерирует анализ только новых постов
- **Добавляет** к существующему профилю (не заменяет)
- Обновляет `last_seen_date`

**Команда:**
```bash
python scripts/profiles/fill_profiles_from_channels.py --all --incremental
```

## Логика определения новых постов

```python
if mode == 'incremental' and user.last_seen_date:
    cutoff_date = user.last_seen_date
    new_posts = [p for p in posts if p.date > cutoff_date]
    
    if not new_posts:
        # Нет новых постов - пропускаем
        return
```

## Структура обновлённого профиля

### Полное заполнение:
```
psychological_summary:
"1. ОТРАЖЕНИЕ В ЗЕРКАЛЕ: ...
2. АРХИТЕКТУРА ЗАЩИТ: ...
3. ПОСЛЕДСТВИЯ: ...
4. ПУТЬ ПРЕОБРАЖЕНИЯ: ..."
```

### После инкрементального обновления:
```
psychological_summary:
"1. ОТРАЖЕНИЕ В ЗЕРКАЛЕ: ...
2. АРХИТЕКТУРА ЗАЩИТ: ...
3. ПОСЛЕДСТВИЯ: ...
4. ПУТЬ ПРЕОБРАЖЕНИЯ: ...

--- ОБНОВЛЕНИЕ 2025-11-22 ---
Новые паттерны на основе последних постов:
- Усиление интереса к теме X
- Появление нового паттерна Y
- Изменение в отношении к Z"
```

## Примеры использования

### Первый запуск (полное заполнение):
```bash
# Обработать все каналы, заполнить профили
python scripts/profiles/fill_profiles_from_channels.py --all

# Результат:
# - 80 пользователей найдено
# - 80 профилей заполнено (full mode)
# - last_seen_date = 2025-11-22 10:00:00
```

### Через неделю (инкрементальное обновление):
```bash
# Обработать все каналы, обновить только новые посты
python scripts/profiles/fill_profiles_from_channels.py --all --incremental

# Результат:
# - 80 пользователей найдено
# - 45 пользователей с новыми постами
# - 45 профилей обновлено (incremental mode)
# - 35 пользователей без новых постов (пропущено)
# - last_seen_date = 2025-11-29 10:00:00
```

### Конкретный канал:
```bash
# Инкрементальное обновление для конкретного канала
python scripts/profiles/fill_profiles_from_channels.py --channel @relove --incremental
```

## Преимущества инкрементального обновления

✅ **Экономия времени**: Обрабатываются только новые посты  
✅ **Экономия API-запросов**: Не запрашиваем фото и bio повторно  
✅ **История изменений**: Видно как профиль эволюционирует  
✅ **Меньше нагрузка на LLM**: Короткие промпты вместо полных  

## Сравнение производительности

### Полное заполнение:
```
Пользователь: 50 постов
Промпт: bio + 50 постов = ~5000 токенов
Время: ~30 секунд
Стоимость: ~$0.01
```

### Инкрементальное обновление:
```
Пользователь: 5 новых постов
Промпт: 5 новых постов = ~500 токенов
Время: ~5 секунд
Стоимость: ~$0.001
```

**Экономия**: 10x по времени и стоимости!

## Поля в БД

### `last_seen_date`
- Обновляется после каждой обработки
- Используется как cutoff для новых постов
- Тип: `DateTime`

### `psychological_summary`
- **Full mode**: Полностью заменяется
- **Incremental mode**: Добавляется секция с датой

### `profile_summary`
- Обновляется только в full mode
- Содержит список каналов

## Логика в коде

```python
# Определение режима
if not user.profile_summary or not user.psychological_summary:
    mode = 'full'
else:
    mode = 'incremental'

# Фильтрация постов
if mode == 'incremental':
    new_posts = [p for p in posts if p.date > user.last_seen_date]
    if not new_posts:
        return  # Пропускаем
else:
    new_posts = posts  # Все посты

# Генерация анализа
if mode == 'incremental':
    new_insights = analyze(new_posts)
    user.psychological_summary += f"\n\n--- UPDATE {date} ---\n{new_insights}"
else:
    summary = analyze(bio + all_posts)
    user.psychological_summary = summary

# Обновление даты
user.last_seen_date = now()
```

## Рекомендации

### Частота запуска:

**Полное заполнение:**
- Первый раз
- После значительных изменений в логике анализа
- Раз в 3-6 месяцев для "освежения" профилей

**Инкрементальное обновление:**
- Ежедневно (для активных сообществ)
- Еженедельно (для умеренно активных)
- По требованию (после важных событий)

### Мониторинг:

```bash
# Проверить сколько пользователей нуждаются в обновлении
SELECT COUNT(*) FROM users 
WHERE last_seen_date < NOW() - INTERVAL '7 days';

# Проверить средний размер профилей
SELECT AVG(LENGTH(psychological_summary)) FROM users;
```

## Ограничения

⚠️ **Размер профиля**: При частых инкрементальных обновлениях `psychological_summary` может стать очень большим. Рекомендуется периодически делать полное обновление.

⚠️ **Контекст**: LLM при инкрементальном обновлении не видит старые посты, только новые. Для глубокого анализа лучше полное обновление.

⚠️ **Cutoff date**: Если `last_seen_date` не установлен, инкрементальное обновление работает как полное.

## Troubleshooting

### Проблема: Все пользователи пропускаются

**Причина**: Нет новых постов с момента последнего обновления

**Решение**: Это нормально! Запустите без `--incremental` для полного обновления

### Проблема: Профиль слишком большой

**Причина**: Много инкрементальных обновлений

**Решение**: Запустите полное обновление без `--incremental`

### Проблема: last_seen_date не обновляется

**Причина**: Ошибка при сохранении в БД

**Решение**: Проверьте логи, убедитесь что `session.commit()` выполняется
