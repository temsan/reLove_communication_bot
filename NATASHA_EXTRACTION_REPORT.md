# Отчет: Извлечение стиля Наташи Волкош с правильными reply-цепочками

## Проблема
Предыдущий скрипт извлекал контекст диалогов **по порядку** (2 сообщения до и 2 после), что могло захватывать случайные сообщения других участников, если между репликами проходило много времени.

## Решение
Доработан скрипт `scripts/analysis/extract_natasha_full.py` с логикой:

### 1. Приоритет: reply_to_msg_id
- Проверяется `message.reply_to.reply_to_msg_id`
- Извлекается **реальное сообщение**, на которое отвечает Наташа
- Строится **полная цепочка реплаев** (до 5 уровней глубины)

### 2. Fallback: контекст по порядку
- Если reply нет - берется контекст как раньше (2 до, 2 после)

### 3. Метаданные
- Добавлено поле `has_reply_chain: true/false`
- Добавлено поле `is_reply_target` для каждого сообщения в цепочке
- Добавлено поле `message_id` для отслеживания

## Результаты

### Файлы
- **JSON**: `data/natasha_full_content_20251122_090907.json`
- **TXT**: `data/natasha_all_text_20251122_090907.txt`

### Статистика
- **Всего постов Наташи**: 573
- **Диалогов с контекстом**: 573
- **Диалогов с reply-цепочками**: ~500+ (большинство)

### Пример структуры диалога
```json
{
  "chat": "reLove open Chat",
  "date": "2025-11-05T18:27:53+00:00",
  "natasha_message": "Да, слежу. Чтобы твои мачты не сильно розовели...",
  "has_reply_chain": true,
  "context": [
    {
      "sender_name": "Unknown",
      "text": "Что это? Клетки, связанные внутри...",
      "is_reply_target": false
    },
    {
      "sender_name": "Наташа Волкош",
      "is_natasha": true,
      "text": "О том, чтобы ты встретились со своим страхом...",
      "is_reply_target": false
    },
    {
      "sender_name": "Unknown",
      "text": "Ты следишь за мной?...",
      "is_reply_target": true
    },
    {
      "sender_name": "Наташа Волкош",
      "is_natasha": true,
      "text": "Да, слежу. Чтобы твои мачты не сильно розовели..."
    }
  ]
}
```

## Использование

### Повторный запуск
```bash
python scripts/analysis/extract_natasha_full.py --natasha --limit 1000
```

### Извлечение постов конкретного пользователя
```bash
python scripts/analysis/extract_natasha_full.py --user 123456789 --limit 1000
```

## Преимущества
✅ Реальный контекст диалогов (на что именно отвечает Наташа)
✅ Полные цепочки реплаев (если диалог многоуровневый)
✅ Fallback на контекст по порядку (если reply нет)
✅ Метаданные для анализа качества данных
